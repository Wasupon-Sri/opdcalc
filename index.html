<!DOCTYPE html>
<html lang="en" data-theme="obsidian">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next-Gen OPD Medication Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Futuristic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/heroicons@2.0.13/24/outline/index.js"></script>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Base transitions */
            --transition-speed: 0.4s;
        }

        /* THEME 1: Obsidian Prime (Metallic Gold-Silver-Black) */
        [data-theme="obsidian"] {
            --bg-color: #050505;
            --bg-gradient: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%);
            --glass-bg: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 215, 0, 0.3); /* Gold tint */
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --accent-color: #d4af37; /* Gold */
            --accent-glow: rgba(212, 175, 55, 0.5);
            --btn-grad-start: #d4af37;
            --btn-grad-end: #c0c0c0; /* Silver */
            --btn-text: #000;
            --grid-color: rgba(255, 255, 255, 0.05);
            --input-bg: rgba(255, 255, 255, 0.05);
        }

        /* THEME 2: Ethereal Violet (Violet-Pearl-Beige) */
        [data-theme="violet"] {
            --bg-color: #f3e8ff;
            --bg-gradient: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(139, 92, 246, 0.3);
            --text-primary: #4c1d95;
            --text-secondary: #6d28d9;
            --accent-color: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.4);
            --btn-grad-start: #a78bfa;
            --btn-grad-end: #e5e7eb; /* Pearl/Beige tone */
            --btn-text: #fff;
            --grid-color: rgba(139, 92, 246, 0.1);
            --input-bg: rgba(255, 255, 255, 0.8);
        }

        /* THEME 3: Neon Aurora (Cyberpunk) */
        [data-theme="neon"] {
            --bg-color: #0f172a;
            --bg-gradient: radial-gradient(at top right, #020617 0%, #1e1b4b 100%);
            --glass-bg: rgba(15, 23, 42, 0.85);
            --glass-border: rgba(56, 189, 248, 0.5); /* Cyan */
            --text-primary: #e0f2fe;
            --text-secondary: #94a3b8;
            --accent-color: #0ea5e9; /* Sky Blue */
            --accent-glow: rgba(14, 165, 233, 0.8);
            --btn-grad-start: #0ea5e9;
            --btn-grad-end: #ec4899; /* Pink/Aurora */
            --btn-text: #fff;
            --grid-color: rgba(56, 189, 248, 0.15);
            --input-bg: rgba(30, 41, 59, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Moving Grid Background */
        .cyber-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 200vw;
            height: 200vh;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            z-index: -1;
            pointer-events: none;
            opacity: 0.5;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px) translateZ(-200px); }
        }

        /* Typography Override for Headers */
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 0.05em;
        }
        
        .tab, .btn-primary, .btn-secondary {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Glass Cards with Breathing Glow */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: all var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
            animation: breathe 8s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 15px var(--glass-border); border-color: var(--glass-border); }
            50% { box-shadow: 0 0 25px var(--accent-glow); border-color: var(--accent-color); }
        }

        .result-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid var(--accent-color);
        }

        /* Inputs */
        .input-field {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-glow);
            transform: scale(1.01);
        }
        
        /* Dropdown/Select overrides for dark modes */
        select.input-field option {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        /* Buttons */
        .btn-primary {
            background-image: linear-gradient(90deg, var(--btn-grad-start), var(--btn-grad-end));
            color: var(--btn-text);
            padding: 0.85rem 2rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px var(--accent-glow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 0 25px var(--accent-glow);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: var(--accent-color);
            color: var(--btn-text);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Navigation Tabs */
        .main-tab-nav {
            background: var(--input-bg);
            border-radius: 1rem;
            padding: 0.5rem;
            border: 1px solid var(--glass-border);
        }

        .main-tab-nav button {
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .main-tab-nav button:hover {
            color: var(--accent-color);
            opacity: 1;
        }

        .main-tab-nav button.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
            opacity: 1;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .sub-tab-nav button {
            color: var(--text-secondary);
            padding: 0.5rem 1.5rem;
            border-radius: 99px;
            transition: all 0.3s;
        }

        .sub-tab-nav button.active {
            background: var(--accent-color);
            color: var(--btn-text);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 50;
        }
        .theme-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }
        .theme-dot:hover { transform: scale(1.2); }
        .theme-dot.obsidian { background: linear-gradient(135deg, #000, #d4af37); }
        .theme-dot.violet { background: linear-gradient(135deg, #f3e8ff, #8b5cf6); }
        .theme-dot.neon { background: linear-gradient(135deg, #0f172a, #0ea5e9); }
        .theme-dot.random { background: conic-gradient(red, orange, yellow, green, blue, indigo, violet, red); border-radius: 4px; }

        /* Animations */
        .animated-result {
            display: none;
            animation: holographFade 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes holographFade {
            0% { opacity: 0; transform: scaleY(0.8) translateY(20px); filter: blur(10px); }
            100% { opacity: 1; transform: scaleY(1) translateY(0); filter: blur(0); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* Text Gradients */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, var(--accent-color), var(--text-primary));
        }

        /* Modal */
        #customModal {
            backdrop-filter: blur(5px);
        }
        #customModal .modal-content {
            background: var(--bg-color);
            border: 1px solid var(--accent-color);
            box-shadow: 0 0 50px var(--accent-glow);
            color: var(--text-primary);
        }
    </style>
</head>
<body>

    <div class="cyber-grid"></div>

    <!-- Theme Switcher UI -->
    <div class="theme-switcher">
        <div class="theme-dot obsidian" onclick="setTheme('obsidian')" title="Obsidian Prime"></div>
        <div class="theme-dot violet" onclick="setTheme('violet')" title="Ethereal Violet"></div>
        <div class="theme-dot neon" onclick="setTheme('neon')" title="Neon Aurora"></div>
        <div class="theme-dot random" onclick="setRandomTheme()" title="Randomize Flux"></div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl relative z-10">
        <header class="text-center mb-10 pt-10">
            <div class="inline-flex items-center gap-4 animate-pulse">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12" style="color: var(--accent-color)">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5v-5.714c0-.597-.237-1.17-.659-1.591L14.25 3.104" />
                     <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                 </svg>
                <h1 class="text-5xl md:text-6xl font-black text-gradient uppercase">
                    MedDose Pro
                </h1>
            </div>
            <p class="mt-3 text-lg font-mono tracking-widest" style="color: var(--text-secondary)">OPD TACTICAL MEDICATION SYSTEM V.2.0</p>
        </header>

        <!-- Date Calculator Card -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 border-b pb-4" style="border-color: var(--glass-border)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Temporal Synchronization
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                <div>
                    <label for="currentDate" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Current Date</label>
                    <input type="date" id="currentDate" class="input-field opacity-75 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="appointmentDate" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Next Appointment</label>
                    <input type="date" id="appointmentDate" class="input-field">
                </div>
                <div>
                    <label for="totalWeeks" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Supply Weeks</label>
                    <input type="number" id="totalWeeks" class="input-field" min="0" step="any" placeholder="4">
                </div>
                <div>
                    <label for="totalDays" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Supply Days</label>
                    <input type="number" id="totalDays" class="input-field" min="1" placeholder="30">
                </div>
            </div>
        </div>

        <!-- Main Calculator Section -->
        <div>
            <div class="main-tab-nav flex flex-wrap justify-center md:justify-start items-center gap-4 mb-8">
                <button id="tab-simple" class="tab active px-4 py-2 text-lg" onclick="switchTab('simple')">Simple Prescription</button>
                <button id="tab-warfarin" class="tab px-4 py-2 text-lg" onclick="switchTab('warfarin')">Warfarin Calc</button>
                <button id="tab-inr" class="tab px-4 py-2 text-lg" onclick="switchTab('inr')">INR Adjust</button>
            </div>

            <!-- Simple Prescription Calculator -->
            <div id="calculator-simple">
                <div class="card">
                     <label class="block text-sm font-bold uppercase tracking-wider mb-4" style="color: var(--accent-color)">Prescription Protocol</label>
                     <div class="flex flex-col sm:flex-row gap-4 mb-6">
                         <label class="flex-1 flex items-center space-x-3 p-4 border rounded-xl cursor-pointer transition-all hover:bg-white/5" style="border-color: var(--glass-border)">
                             <input type="radio" name="prescriptionType" value="daily" class="form-radio text-sky-500 w-5 h-5 focus:ring-0" checked onchange="togglePrescriptionType(this.value)">
                             <span class="font-medium">Standard Daily Dose</span>
                         </label>
                         <label class="flex-1 flex items-center space-x-3 p-4 border rounded-xl cursor-pointer transition-all hover:bg-white/5" style="border-color: var(--glass-border)">
                             <input type="radio" name="prescriptionType" value="weekly" class="form-radio text-sky-500 w-5 h-5 focus:ring-0" onchange="togglePrescriptionType(this.value)">
                             <span class="font-medium">Complex Weekly Cycle</span>
                         </label>
                     </div>

                    <!-- Container for the standard daily input -->
                    <div id="daily-dose-container">
                        <label for="simplePrescription" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Input Formula</label>
                        <input type="text" id="simplePrescription" placeholder="Syntax: 1x2, 12, or 0.5*3" class="input-field">
                        <p id="simplePrescriptionError" class="error-message text-red-400 mt-2 hidden text-sm">Invalid syntax. Use '1x2' or numeric value.</p>
                    </div>

                    <!-- Container for the new weekly/day-specific input -->
                    <div id="weekly-dose-container" class="hidden">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Specific Regimen</label>
                        <div id="specific-day-rows" class="space-y-3 mb-4">
                            <!-- JS will populate this -->
                        </div>
                        <button onclick="addSpecificDayRow()" class="btn-secondary text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Add Vector
                        </button>
                    </div>

                    <!-- Shared Calculate Button -->
                    <div class="mt-8 pt-6 border-t" style="border-color: var(--glass-border)">
                         <button onclick="calculateSimpleDosage()" class="btn-primary w-full md:w-auto text-lg shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm0 3h.008v.008H8.25v-.008zm3-6h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm0 3h.008v.008H11.25v-.008zm3-6h.008v.008H14.25v-.008zm0 3h.008v.008H14.25v-.008zM4.5 12.75a.75.75 0 01.75-.75h13.5a.75.75 0 010 1.5H5.25a.75.75 0 01-.75-.75z" /></svg>
                            Execute Calculation
                        </button>
                    </div>
                </div>
                <div id="simpleResult" class="animated-result">
                    <div class="card result-card">
                       <h3 class="font-bold text-2xl mb-6" style="color: var(--accent-color)">Analysis Complete</h3>
                       <div class="flex flex-col md:flex-row gap-6 text-center">
                           <div class="flex-1 p-6 rounded-2xl border transition-transform hover:scale-105" style="background: rgba(255,255,255,0.05); border-color: var(--glass-border)">
                               <p id="simpleDailyDoseLabel" class="text-sm font-semibold uppercase tracking-widest opacity-70">Tablets / Day</p>
                               <p id="simpleDailyTablets" class="font-black text-6xl mt-2 font-mono" style="text-shadow: 0 0 20px var(--accent-glow)"></p>
                           </div>
                           <div class="flex-1 p-6 rounded-2xl border transition-transform hover:scale-105" style="background: rgba(255,255,255,0.05); border-color: var(--glass-border)">
                               <p class="text-sm font-semibold uppercase tracking-widest opacity-70">Total Supply</p>
                               <p id="simpleTotalTablets" class="font-black text-6xl mt-2 font-mono" style="text-shadow: 0 0 20px var(--accent-glow)"></p>
                           </div>
                       </div>
                       <div id="simpleWeeklyBreakdown" class="hidden mt-6 p-4 rounded-xl border border-dashed" style="border-color: var(--accent-color)">
                            <h4 class="font-semibold mb-2 opacity-80">Weekly Cycle Map:</h4>
                            <p id="simpleWeeklyBreakdownText" class="text-lg font-mono"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warfarin Calculator -->
            <div id="calculator-warfarin" class="hidden">
                <div class="card">
                    <div class="p-4 rounded-xl mb-6 flex items-start gap-3 border" style="background: rgba(var(--accent-color), 0.1); border-color: var(--glass-border)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 shrink-0"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>
                        <p class="text-sm font-medium opacity-80">Optimization Algorithm Active: Prioritizes 2mg, 3mg, 5mg combinations for maximum patient adherence (minimal pill fragmentation).</p>
                    </div>
                    
                    <div class="flex justify-center border-b mb-8 sub-tab-nav pb-4" style="border-color: var(--glass-border)">
                         <button id="warfarin-tab-daily" class="tab active mx-2" onclick="switchWarfarinTab('daily')">Manual Daily Entry</button>
                         <button id="warfarin-tab-twd" class="tab mx-2" onclick="switchWarfarinTab('twd')">Weekly Target (TWD)</button>
                    </div>

                    <div id="twd-input-section" class="mb-4 hidden">
                        <label for="twdInput" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Total Weekly Dose (mg)</label>
                        <div class="flex items-center gap-4">
                            <input type="number" id="twdInput" placeholder="e.g., 30.5" class="input-field text-2xl" min="0" step="0.5">
                            <button onclick="distributeTWD()" class="btn-primary whitespace-nowrap">Find Combinations</button>
                        </div>
                    </div>
                    
                    <div id="twdOptionsContainer" class="hidden mt-6 space-y-4"></div>

                    <div id="daily-dose-section">
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"></div>
                        <p id="dailyDoseError" class="error-message text-red-400 mt-4 hidden font-bold">Error: Impossible combination detected.</p>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t" style="border-color: var(--glass-border)">
                        <button onclick="calculateWarfarinDosage()" class="btn-primary w-full md:w-auto shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" /></svg>
                            Compute Logistics
                        </button>
                    </div>
                </div>
                <div id="warfarinResult" class="animated-result">
                     <div class="card result-card">
                        <h3 class="font-bold text-2xl mb-4" style="color: var(--accent-color)">Supply Manifest</h3>
                        <div class="mt-4">
                            <p class="font-medium opacity-80 mb-4">Total requirements for <span id="warfarinTotalDays" class="font-bold text-lg" style="color: var(--accent-color)"></span> days:</p>
                            <div class="grid grid-cols-3 gap-6 mt-2 text-center">
                                <div class="p-4 rounded-xl border relative overflow-hidden" style="background: rgba(255,255,255,0.05); border-color: var(--glass-border)">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-pink-500"></div>
                                    <p class="text-xs font-bold uppercase tracking-widest opacity-60 mb-2">5mg (Pink)</p>
                                    <p id="total5mg" class="font-black text-4xl"></p>
                                </div>
                                <div class="p-4 rounded-xl border relative overflow-hidden" style="background: rgba(255,255,255,0.05); border-color: var(--glass-border)">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                                    <p class="text-xs font-bold uppercase tracking-widest opacity-60 mb-2">3mg (Blue)</p>
                                    <p id="total3mg" class="font-black text-4xl"></p>
                                </div>
                                <div class="p-4 rounded-xl border relative overflow-hidden" style="background: rgba(255,255,255,0.05); border-color: var(--glass-border)">
                                    <div class="absolute top-0 left-0 w-full h-1 bg-orange-400"></div>
                                    <p class="text-xs font-bold uppercase tracking-widest opacity-60 mb-2">2mg (Orange)</p>
                                    <p id="total2mg" class="font-black text-4xl"></p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 overflow-x-auto rounded-lg border" style="border-color: var(--glass-border)">
                            <table class="min-w-full text-left">
                                <thead style="background: rgba(255,255,255,0.1)">
                                    <tr>
                                        <th class="p-4 font-bold text-sm uppercase tracking-wider">Day</th>
                                        <th class="p-4 text-center font-bold text-sm uppercase tracking-wider">Dose (mg)</th>
                                        <th class="p-4 text-center font-bold text-sm uppercase tracking-wider">5mg</th>
                                        <th class="p-4 text-center font-bold text-sm uppercase tracking-wider">3mg</th>
                                        <th class="p-4 text-center font-bold text-sm uppercase tracking-wider">2mg</th>
                                    </tr>
                                </thead>
                                <tbody id="warfarinBreakdownTable" class="divide-y" style="divide-color: var(--glass-border)"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INR-Based TWD Adjustment Calculator -->
            <div id="calculator-inr" class="hidden">
                <div class="card">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2" style="color: var(--accent-color)">Coagulation Control</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div>
                            <label for="currentInr" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Current INR</label>
                            <input type="number" id="currentInr" placeholder="e.g., 2.5" class="input-field text-2xl" step="0.1">
                        </div>
                        <div>
                            <label for="currentTwd" class="block text-sm font-semibold mb-2" style="color: var(--text-secondary)">Current Weekly Dose (TWD)</label>
                            <input type="number" id="currentTwd" placeholder="e.g., 35" class="input-field text-2xl" step="0.5">
                        </div>
                        <div class="md:col-span-2">
                             <label class="block text-sm font-semibold mb-3 uppercase tracking-wider" style="color: var(--accent-color)">Clinical Guideline</label>
                             <div class="flex flex-col sm:flex-row gap-4">
                                 <label class="flex items-center space-x-3 p-4 border rounded-xl cursor-pointer hover:bg-white/5 transition-all" style="border-color: var(--glass-border)">
                                     <input type="radio" name="guideline" value="thai" class="form-radio text-sky-500 focus:ring-0" checked onchange="updateInrReferenceTable()">
                                     <span class="font-medium">Thai Society of Hematology</span>
                                 </label>
                                 <label class="flex items-center space-x-3 p-4 border rounded-xl cursor-pointer hover:bg-white/5 transition-all" style="border-color: var(--glass-border)">
                                     <input type="radio" name="guideline" value="accp" class="form-radio text-sky-500 focus:ring-0" onchange="updateInrReferenceTable()">
                                     <span class="font-medium">Standard (ACCP)</span>
                                 </label>
                             </div>
                        </div>
                    </div>
                     <div class="mt-8 pt-6 border-t" style="border-color: var(--glass-border)">
                        <button onclick="calculateInrAdjustment()" class="btn-primary w-full md:w-auto shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991 0l-3.182-3.182a8.25 8.25 0 00-11.667 0l3.182 3.182z" /></svg>
                            Calculate Adjustment
                        </button>
                    </div>
                </div>
                <div id="inrResult" class="animated-result">
                    <div class="card result-card">
                          <h3 class="font-bold text-2xl mb-4" style="color: var(--accent-color)">Clinical Recommendation</h3>
                          <div class="mt-4 space-y-4">
                            <div class="p-4 rounded-lg bg-white/5 border-l-4" style="border-color: var(--accent-color)">
                                <p class="opacity-70 text-sm uppercase">Action Required</p>
                                <p id="inrAction" class="font-bold text-lg mt-1"></p>
                            </div>
                            
                            <p id="inrHoldDoseLine" class="hidden p-2 bg-red-500/10 border border-red-500/30 rounded text-red-300">Hold: <span id="inrHoldDose" class="font-bold"></span></p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="opacity-70 text-sm">Target Range</p>
                                    <p class="text-xl font-mono"><span id="newTwdRange" class="font-bold" style="color: var(--accent-color)"></span> mg</p>
                                </div>
                                <div>
                                    <p class="opacity-70 text-sm">Suggested Target</p>
                                    <p class="text-xl font-mono"><span id="suggestedNewTwd" class="font-bold" style="color: var(--accent-color)"></span> mg</p>
                                </div>
                            </div>
                          </div>
                          <div class="mt-8">
                              <button id="applyNewTwdBtn" class="btn-secondary w-full md:w-auto">Transfer to Calculator</button>
                          </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-bold mb-4 opacity-80 uppercase tracking-widest">Protocol Matrix</h3>
                    <div class="overflow-x-auto rounded-xl border" style="border-color: var(--glass-border)">
                        <table class="min-w-full text-sm text-left">
                            <thead style="background: rgba(255,255,255,0.1)">
                                <tr>
                                    <th class="p-3 font-semibold">INR Range</th>
                                    <th class="p-3 font-semibold">Standard Protocol</th>
                                    <th class="p-3 font-semibold">TWD % Adjustment</th>
                                </tr>
                            </thead>
                            <tbody id="inrReferenceTable" class="divide-y" style="divide-color: rgba(255,255,255,0.05)">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content rounded-2xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1" style="background: var(--accent-color)"></div>
            <h3 id="modalTitle" class="text-xl font-bold font-orbitron mb-2" style="color: var(--accent-color)">System Alert</h3>
            <p id="modalMessage" class="mt-2 text-lg leading-relaxed opacity-90">Notification message.</p>
            <div class="mt-8 text-right">
                <button id="modalCloseBtn" class="btn-primary">Acknowledge</button>
            </div>
        </div>
    </div>

    <script>
        // --- THEME ENGINE ---
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            // Reset custom colors if coming from random
            if(themeName !== 'random') {
                document.documentElement.style.removeProperty('--accent-color');
            }
        }

        function setRandomTheme() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.floor(Math.random() * 30);
            const lightness = 50 + Math.floor(Math.random() * 10);
            
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            const glow = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.5)`;
            
            document.documentElement.setAttribute('data-theme', 'neon'); // Use neon base
            document.documentElement.style.setProperty('--accent-color', color);
            document.documentElement.style.setProperty('--accent-glow', glow);
            document.documentElement.style.setProperty('--glass-border', `hsla(${hue}, ${saturation}%, ${lightness}%, 0.3)`);
            document.documentElement.style.setProperty('--btn-grad-start', color);
            document.documentElement.style.setProperty('--btn-grad-end', `hsl(${hue + 30}, ${saturation}%, ${lightness}%)`);
        }

        // --- CUSTOM MODAL ---
        const modal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        });

        // --- GLOBAL STATE ---
        let appliedRegimenCombinations = null;
        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];


        // --- UTILITY AND INITIALIZATION ---
        const currentDateInput = document.getElementById('currentDate');
        const appointmentDateInput = document.getElementById('appointmentDate');
        const totalDaysInput = document.getElementById('totalDays');
        const totalWeeksInput = document.getElementById('totalWeeks');

        const today = new Date();
        const formatDate = (date) => date.toISOString().split('T')[0];
        currentDateInput.value = formatDate(today);

        // --- DATE CALCULATION LOGIC ---
        // From Date to Days/Weeks
        function updateDaysAndWeeks() {
            const start = new Date(currentDateInput.value);
            const end = new Date(appointmentDateInput.value);
            if (!isNaN(start.getTime()) && !isNaN(end.getTime()) && end >= start) {
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                totalDaysInput.value = diffDays;
                totalWeeksInput.value = parseFloat((diffDays / 7).toFixed(2));
            } else {
                totalDaysInput.value = '';
                totalWeeksInput.value = '';
            }
        }

        // From Days to Date/Weeks
        function updateDateAndWeeks() {
            const days = parseInt(totalDaysInput.value, 10);
            const start = new Date(currentDateInput.value);
            if (!isNaN(days) && days > 0 && !isNaN(start.getTime())) {
                // Update weeks
                totalWeeksInput.value = parseFloat((days / 7).toFixed(2));
                // Update date
                const newDate = new Date(start.getTime());
                newDate.setDate(start.getDate() + days - 1);
                appointmentDateInput.value = formatDate(newDate);
            } else {
                appointmentDateInput.value = '';
                totalWeeksInput.value = '';
            }
        }

        // From Weeks to Date/Days
        function updateDateAndDays() {
            const weeks = parseFloat(totalWeeksInput.value);
            if (!isNaN(weeks) && weeks > 0) {
                const days = Math.round(weeks * 7);
                totalDaysInput.value = days;
                // Now that days is updated, trigger the update from days
                updateDateAndWeeks();
            } else {
                totalDaysInput.value = '';
                appointmentDateInput.value = '';
            }
        }

        appointmentDateInput.addEventListener('change', updateDaysAndWeeks);
        totalDaysInput.addEventListener('input', updateDateAndWeeks);
        totalWeeksInput.addEventListener('input', updateDateAndDays);

        // --- UI TAB SWITCHING ---
        function switchTab(tabName) {
            document.getElementById('calculator-simple').classList.toggle('hidden', tabName !== 'simple');
            document.getElementById('calculator-warfarin').classList.toggle('hidden', tabName !== 'warfarin');
            document.getElementById('calculator-inr').classList.toggle('hidden', tabName !== 'inr');
            
            document.querySelectorAll('.main-tab-nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function switchWarfarinTab(tabName) {
            document.getElementById('twd-input-section').classList.toggle('hidden', tabName !== 'twd');
            document.getElementById('daily-dose-section').classList.toggle('hidden', tabName === 'twd');
            document.getElementById('twdOptionsContainer').classList.add('hidden');
            
            document.querySelectorAll('.sub-tab-nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`warfarin-tab-${tabName}`).classList.add('active');

            if (tabName === 'daily') {
                appliedRegimenCombinations = null;
            }
        }

        // --- SIMPLE PRESCRIPTION CALCULATOR (NEW & UPDATED) ---
        function togglePrescriptionType(type) {
            document.getElementById('daily-dose-container').classList.toggle('hidden', type !== 'daily');
            const weeklyContainer = document.getElementById('weekly-dose-container');
            weeklyContainer.classList.toggle('hidden', type !== 'weekly');
            document.getElementById('simpleResult').style.display = 'none'; // Hide result on switch

            if (type === 'weekly' && weeklyContainer.querySelector('.specific-day-row') === null) {
                addSpecificDayRow(); // Add an initial row for convenience
            }
        }

        function addSpecificDayRow() {
            const container = document.getElementById('specific-day-rows');
            const row = document.createElement('div');
            row.className = 'specific-day-row flex items-center gap-3 p-2 rounded-md bg-white/5';

            const dayOptions = daysOfWeek.map(day => `<option value="${day}">${day}</option>`).join('');

            row.innerHTML = `
                <select class="input-field flex-grow !py-2">
                    <option value="">Select Day</option>
                    ${dayOptions}
                </select>
                <input type="number" class="input-field w-32 !py-2" placeholder="Tablets" min="0" step="0.5">
                <button onclick="removeSpecificDayRow(this)" class="text-red-400 hover:text-red-300 p-2 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            `;
            container.appendChild(row);
        }

        function removeSpecificDayRow(buttonEl) {
            buttonEl.parentElement.remove();
        }

        function calculateSimpleDosage() {
            const days = parseInt(totalDaysInput.value, 10);
            const resultEl = document.getElementById('simpleResult');
            const weeklyBreakdownEl = document.getElementById('simpleWeeklyBreakdown');
            
            resultEl.style.display = 'none';
            weeklyBreakdownEl.classList.add('hidden');

            if (!days || days <= 0) {
                showModal("Please set a valid number of days for the supply.");
                return;
            }

            const prescriptionType = document.querySelector('input[name="prescriptionType"]:checked').value;
            
            let totalTablets = 0;
            let dailyOrAvgTablets = 0;
            let dailyDoseLabel = "Tablets Per Day";

            if (prescriptionType === 'daily') {
                const prescription = document.getElementById('simplePrescription').value.trim();
                const errorEl = document.getElementById('simplePrescriptionError');
                let dailyTablets = null;
                const comboRegex = /^(\d*\.?\d+)\s*[xX*]\s*(\d+)$/;
                const comboMatch = prescription.match(comboRegex);
                const singleNumberRegex = /^\d*\.?\d+$/;
                
                if (comboMatch) {
                    dailyTablets = parseFloat(comboMatch[1]) * parseInt(comboMatch[2], 10);
                } else if (singleNumberRegex.test(prescription)) {
                    dailyTablets = parseFloat(prescription);
                }

                if (dailyTablets !== null && !isNaN(dailyTablets)) {
                    errorEl.style.display = 'none';
                    totalTablets = dailyTablets * days;
                    dailyOrAvgTablets = dailyTablets;
                } else {
                    errorEl.style.display = 'block';
                    return;
                }

            } else { // Weekly Dose Logic
                const dayRows = document.querySelectorAll('.specific-day-row');
                if (dayRows.length === 0) {
                    showModal("Please add at least one day-specific dose.");
                    return;
                }

                const dosesByDay = {};
                let hasInputError = false;

                dayRows.forEach(row => {
                    const day = row.querySelector('select').value;
                    const doseInput = row.querySelector('input[type="number"]');
                    const dose = parseFloat(doseInput.value);

                    if (day && !isNaN(dose) && dose > 0) {
                        dosesByDay[day] = (dosesByDay[day] || 0) + dose;
                    } else if (day || doseInput.value) {
                        hasInputError = true;
                    }
                });

                if (hasInputError) {
                    showModal("Please ensure all day-specific dose rows are filled out correctly (select a day and enter a valid dose).");
                    return;
                }
                
                if (Object.keys(dosesByDay).length === 0) {
                    showModal("Please enter at least one valid day-specific dose.");
                    return;
                }

                const startDate = new Date(currentDateInput.value);
                for (let i = 0; i < days; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);
                    const dayIndex = (currentDate.getDay() + 6) % 7; // Monday=0, Sunday=6
                    const dayName = daysOfWeek[dayIndex];
                    
                    if (dosesByDay[dayName]) {
                        totalTablets += dosesByDay[dayName];
                    }
                }
                
                dailyOrAvgTablets = days > 0 ? totalTablets / days : 0;
                dailyDoseLabel = "Avg. Tablets Per Day";

                const breakdownText = Object.entries(dosesByDay)
                                            .map(([day, dose]) => `${day}: ${dose} tab(s)`)
                                            .join('; ');
                document.getElementById('simpleWeeklyBreakdownText').textContent = breakdownText;
                weeklyBreakdownEl.classList.remove('hidden');
            }

            const formatNumber = (num) => num.toFixed(2).replace(/\.00$/, '').replace(/\.([1-9])0$/, '.$1');
            document.getElementById('simpleDailyDoseLabel').textContent = dailyDoseLabel;
            document.getElementById('simpleDailyTablets').textContent = formatNumber(dailyOrAvgTablets);
            document.getElementById('simpleTotalTablets').textContent = formatNumber(totalTablets);
            resultEl.style.display = 'block';
        }


        // --- WARFARIN CALCULATOR ---
        const dailyDoseContainer = document.querySelector('#daily-dose-section .grid');

        daysOfWeek.forEach(day => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label for="dose-${day.toLowerCase()}" class="block text-xs font-bold uppercase tracking-wider mb-1 opacity-70">${day.substring(0,3)}</label>
                <input type="number" id="dose-${day.toLowerCase()}" data-day="${day}" class="input-field daily-dose-input text-center" placeholder="0" min="0" step="0.5">
            `;
            dailyDoseContainer.appendChild(div);
        });

        function getTabletCombination(dose, allowedStrengths = [5, 3, 2]) {
            if (dose === 0) return { '5mg': 0, '3mg': 0, '2mg': 0 };
            if (dose < 1 || dose % 0.5 !== 0) return null;

            const max_pills = 4;
            const strengths = [5, 3, 2].filter(s => allowedStrengths.includes(s));
            
            let singleStrengthSolutions = [];
            for (const s of strengths) {
                if ((dose / s) % 0.5 === 0) {
                    const num_tabs = dose / s;
                    if (num_tabs <= max_pills) {
                        let combo = { '5mg': 0, '3mg': 0, '2mg': 0 };
                        combo[`${s}mg`] = num_tabs;
                        singleStrengthSolutions.push({ combo, totalPills: num_tabs });
                    }
                }
            }
            if (singleStrengthSolutions.length > 0) {
                singleStrengthSolutions.sort((a, b) => a.totalPills - b.totalPills);
                return singleStrengthSolutions[0].combo;
            }

            if (strengths.length < 2) return null;
            const pairs = [];
            for (let i = 0; i < strengths.length; i++) {
                for (let j = i + 1; j < strengths.length; j++) {
                    pairs.push([strengths[i], strengths[j]]);
                }
            }

            let twoStrengthSolutions = [];
            for (const [s1, s2] of pairs) {
                for (let n1 = 0; n1 <= max_pills; n1 += 0.5) {
                    for (let n2 = 0; n2 <= max_pills; n2 += 0.5) {
                        if (n1 + n2 > max_pills || n1 + n2 === 0) continue;
                        if (Math.abs((n1 * s1) + (n2 * s2) - dose) < 0.01) {
                            let combo = { '5mg': 0, '3mg': 0, '2mg': 0 };
                            combo[`${s1}mg`] = n1;
                            combo[`${s2}mg`] = n2;
                            const numHalves = (n1 % 1 !== 0 ? 1 : 0) + (n2 % 1 !== 0 ? 1 : 0);
                            const totalPills = n1 + n2;
                            twoStrengthSolutions.push({ combo, numHalves, totalPills });
                        }
                    }
                }
            }
            if (twoStrengthSolutions.length > 0) {
                twoStrengthSolutions.sort((a, b) => {
                    if (a.numHalves !== b.numHalves) return a.numHalves - b.numHalves;
                    return a.totalPills - b.totalPills;
                });
                return twoStrengthSolutions[0].combo;
            }
            
            if (strengths.length < 3) return null;
            let threeStrengthSolutions = [];
            for (let n5 = 0; n5 <= max_pills; n5 += 0.5) {
                for (let n3 = 0; n3 <= max_pills; n3 += 0.5) {
                    for (let n2 = 0; n2 <= max_pills; n2 += 0.5) {
                        if (n5 + n3 + n2 > max_pills || n5 + n3 + n2 === 0) continue;
                        if (n5 > 0 && n3 > 0 && n2 > 0 && Math.abs((n5 * 5) + (n3 * 3) + (n2 * 2) - dose) < 0.01) {
                             const combo = { '5mg': n5, '3mg': n3, '2mg': n2 };
                             const numHalves = (n5 % 1 !== 0 ? 1 : 0) + (n3 % 1 !== 0 ? 1 : 0) + (n2 % 1 !== 0 ? 1 : 0);
                             const totalPills = n5 + n3 + n2;
                             threeStrengthSolutions.push({ combo, numHalves, totalPills });
                        }
                    }
                }
            }
             if (threeStrengthSolutions.length > 0) {
                  threeStrengthSolutions.sort((a, b) => {
                        if (a.numHalves !== b.numHalves) return a.numHalves - b.numHalves;
                        return a.totalPills - b.totalPills;
                   });
                   return threeStrengthSolutions[0].combo;
             }
            
            return null;
        }

        function findBestWeeklyCombination(doses) {
            const uniqueDoses = [...new Set(doses)];
            const strengthSubsets = [ [5], [3], [2], [5,2], [3,2], [5,3], [5,3,2] ];

            for (const allowedStrengths of strengthSubsets) {
                let isPossible = true;
                let regimenCombinations = {};
                for (const dose of uniqueDoses) {
                    const combo = getTabletCombination(dose, allowedStrengths);
                    if (!combo) {
                        isPossible = false;
                        break;
                    }
                    regimenCombinations[dose] = combo;
                }
                if (isPossible) {
                    return regimenCombinations;
                }
            }
            return null;
        }

        function generateAndScoreDistributions(twd) {
            let possibleSolutions = [];
            const avgDose = twd / 7;

            for (let activeDays = 7; activeDays >= 5; activeDays--) {
                const offDays = 7 - activeDays;
                if (twd > 0) {
                    const singleDose = twd / activeDays;
                    if (singleDose > 0 && singleDose % 0.5 === 0 && getTabletCombination(singleDose)) {
                        possibleSolutions.push({ doses: [...Array(activeDays).fill(singleDose), ...Array(offDays).fill(0)] });
                    }
                }
                if (activeDays > 1) {
                    for (let daysA = activeDays - 1; daysA >= Math.ceil(activeDays / 2); daysA--) {
                        const daysB = activeDays - daysA;
                        for (let i = -8; i <= 8; i++) { 
                            const doseA = Math.round(avgDose * 2) / 2 + i * 0.5;
                            if (doseA <= 0 || !getTabletCombination(doseA)) continue;
                            const doseB = (twd - daysA * doseA) / daysB;
                            if (doseB >= 0 && doseB % 0.5 === 0 && getTabletCombination(doseB)) {
                                possibleSolutions.push({ doses: [...Array(daysA).fill(doseA), ...Array(daysB).fill(doseB), ...Array(offDays).fill(0)] });
                            }
                        }
                    }
                }
            }

            if (possibleSolutions.length === 0) return [];
            const uniqueSolutions = Array.from(new Set(possibleSolutions.map(s => JSON.stringify(s.doses.sort((a,b)=>b-a)))))
                                          .map(s => ({ doses: JSON.parse(s) }));

            uniqueSolutions.forEach(sol => {
                const { doses } = sol;
                const combinations = findBestWeeklyCombination(doses);
                if (!combinations) return; 

                let numStrengths = 0;
                let totalHalfDoses = 0;
                const strengthsUsed = new Set();
                
                doses.forEach(d => {
                    const combo = combinations[d];
                    if (combo) {
                        if(combo['5mg'] > 0) strengthsUsed.add(5);
                        if(combo['3mg'] > 0) strengthsUsed.add(3);
                        if(combo['2mg'] > 0) strengthsUsed.add(2);
                        totalHalfDoses += Object.values(combo).filter(num => num % 1 !== 0).length;
                    }
                });
                numStrengths = strengthsUsed.size;

                const variance = doses.reduce((acc, val) => acc + Math.pow(val - avgDose, 2), 0) / 7;
                const uniqueDoseCount = [...new Set(doses.filter(d => d > 0))].length;
                const numOffDays = doses.filter(d => d === 0).length;

                sol.evenScore = variance * 10000 + numStrengths * 100 + totalHalfDoses * 10 + uniqueDoseCount;
                sol.easyScore = numStrengths * 10000 + totalHalfDoses * 1000 + uniqueDoseCount * 100 + numOffDays * 10 + variance;
                sol.regimenInfo = { combinations };
            });

            return uniqueSolutions.filter(sol => sol.regimenInfo);
        }

        function formatRegimen(doses) {
            const counts = doses.reduce((acc, dose) => {
                acc[dose] = (acc[dose] || 0) + 1;
                return acc;
            }, {});

            return Object.entries(counts)
                .sort((a, b) => b[0] - a[0])
                .map(([dose, count]) => `${dose}mg x ${count} day${count > 1 ? 's' : ''}`)
                .join(', ');
        }

        function applyDistribution(doses, regimenInfo) {
            const sortedDoses = [...doses].sort((a, b) => b - a);
            daysOfWeek.forEach((day, index) => {
                const input = document.getElementById(`dose-${day.toLowerCase()}`);
                input.value = Number(sortedDoses[index] || 0).toFixed(2).replace(/\.00$/, '');
            });
            appliedRegimenCombinations = regimenInfo.combinations;
            document.getElementById('twdOptionsContainer').classList.add('hidden');
            switchWarfarinTab('daily');
        }
        
        function distributeTWD() {
            const twd = parseFloat(document.getElementById('twdInput').value);
            const optionsContainer = document.getElementById('twdOptionsContainer');
            optionsContainer.innerHTML = '';

            if (isNaN(twd) || twd < 0) {
                showModal("Please enter a valid Total Weekly Dose.");
                return;
            }

            const allSolutions = generateAndScoreDistributions(twd);

            if (allSolutions.length === 0) {
                showModal(`Could not find a simple, easy-to-remember distribution for TWD = ${twd}mg. Please enter daily doses manually.`);
                return;
            }

            allSolutions.sort((a, b) => a.evenScore - b.evenScore);
            const evenOption = allSolutions[0];
            allSolutions.sort((a, b) => a.easyScore - b.easyScore);
            const easyOption = allSolutions[0];
            
            const createOptionCard = (solution, title, subtitle) => {
                const card = document.createElement('div');
                card.className = 'border rounded-lg p-4 transition-all cursor-pointer hover:bg-white/10';
                card.style.borderColor = 'var(--glass-border)';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-lg" style="color: var(--accent-color)">${title}</h4>
                            <p class="text-xs opacity-70 mb-2">${subtitle}</p>
                            <p class="text-xl font-bold font-mono tracking-tight">${formatRegimen(solution.doses)}</p>
                        </div>
                        <button class="btn-secondary !font-medium !py-1 !px-3">Apply</button>
                    </div>
                `;
                card.onclick = () => applyDistribution(solution.doses, solution.regimenInfo);
                return card;
            };

            optionsContainer.appendChild(createOptionCard(evenOption, 'Most Even Distribution', 'Minimizes day-to-day dose variation.'));
            
            const evenDosesStr = JSON.stringify(evenOption.doses.sort((a,b)=>b-a));
            const easyDosesStr = JSON.stringify(easyOption.doses.sort((a,b)=>b-a));
            if (evenDosesStr !== easyDosesStr) {
                 optionsContainer.appendChild(createOptionCard(easyOption, 'Easiest to Take', 'Uses fewest pill types & avoids half-tablets.'));
            }

            optionsContainer.classList.remove('hidden');
        }

        function calculateWarfarinDosage() {
            const totalDays = parseInt(totalDaysInput.value, 10);
            const errorEl = document.getElementById('dailyDoseError');
            const resultEl = document.getElementById('warfarinResult');
            errorEl.style.display = 'none';

            if (!totalDays || totalDays <= 0) {
                showModal("Please set a valid number of days for the supply.");
                return;
            }

            const dailyInputs = Array.from(document.querySelectorAll('.daily-dose-input'));
            const weeklySchedule = {};
            let hasError = false;

            const weeklyCombinations = appliedRegimenCombinations;

            dailyInputs.forEach((input) => {
                const day = input.dataset.day;
                const dose = parseFloat(input.value) || 0;
                let combination;

                if (weeklyCombinations && weeklyCombinations[dose] !== undefined) {
                    combination = weeklyCombinations[dose];
                } else {
                    combination = getTabletCombination(dose);
                }
                
                if (dose > 0 && !combination) {
                    hasError = true;
                    input.classList.add('border-red-500');
                    input.style.boxShadow = "0 0 10px red";
                } else {
                    input.classList.remove('border-red-500');
                    input.style.boxShadow = "none";
                }
                weeklySchedule[day] = { dose, combination };
            });

            if (hasError) {
                errorEl.textContent = "Invalid dose. One or more doses cannot be formed with 2, 3, 5mg tablets."
                errorEl.style.display = 'block';
                resultEl.style.display = 'none';
                return;
            }

            let total5mg = 0, total3mg = 0, total2mg = 0;
            const startDate = new Date(currentDateInput.value);
            
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dayIndex = (currentDate.getDay() + 6) % 7; 
                const dayName = daysOfWeek[dayIndex];
                
                const daySchedule = weeklySchedule[dayName];
                if (daySchedule && daySchedule.combination) {
                    total5mg += daySchedule.combination['5mg'];
                    total3mg += daySchedule.combination['3mg'];
                    total2mg += daySchedule.combination['2mg'];
                }
            }
            
            const formatNumber = (num) => Number(num.toFixed(2).replace(/\.?0+$/, ''));

            document.getElementById('warfarinTotalDays').textContent = totalDays;
            document.getElementById('total5mg').textContent = formatNumber(total5mg);
            document.getElementById('total3mg').textContent = formatNumber(total3mg);
            document.getElementById('total2mg').textContent = formatNumber(total2mg);

            const tableBody = document.getElementById('warfarinBreakdownTable');
            tableBody.innerHTML = '';
            daysOfWeek.forEach(day => {
                const schedule = weeklySchedule[day];
                const combo = schedule.combination || { '5mg': '-', '3mg': '-', '2mg': '-' };
                const formatTab = (val) => (val === undefined || val === null || val === '-') ? '-' : formatNumber(val);
                const row = `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="p-3 font-medium opacity-80">${day}</td>
                        <td class="p-3 text-center font-bold text-lg">${formatNumber(schedule.dose)}</td>
                        <td class="p-3 text-center text-pink-500 font-bold">${formatTab(combo['5mg'])}</td>
                        <td class="p-3 text-center text-blue-500 font-bold">${formatTab(combo['3mg'])}</td>
                        <td class="p-3 text-center text-orange-400 font-bold">${formatTab(combo['2mg'])}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            resultEl.style.display = 'block';
            appliedRegimenCombinations = null;
        }

        // --- INR-BASED TWD ADJUSTMENT ---
        const guidelines = {
            thai: [
                { range: "< 1.5", minInr: 0, maxInr: 1.49, action: "Increase TWD by 10-20%", minAdj: 0.10, maxAdj: 0.20, hold: null, vitK: null, adjustmentText: "+10% to +20%" },
                { range: "1.5 - 1.9", minInr: 1.5, maxInr: 1.9, action: "Increase TWD by 5-10%", minAdj: 0.05, maxAdj: 0.10, hold: null, vitK: null, adjustmentText: "+5% to +10%" },
                { range: "2.0 - 3.0", minInr: 2.0, maxInr: 3.0, action: "Continue current dose", minAdj: 0, maxAdj: 0, hold: null, vitK: null, adjustmentText: "0%" },
                { range: "3.1 - 3.5", minInr: 3.1, maxInr: 3.5, action: "Decrease TWD by 5-10%", minAdj: -0.10, maxAdj: -0.05, hold: null, vitK: null, adjustmentText: "-5% to -10%" },
                { range: "3.6 - 4.0", minInr: 3.6, maxInr: 4.0, action: "Hold dose, Decrease TWD", minAdj: -0.15, maxAdj: -0.10, hold: "Hold 1 dose", vitK: null, adjustmentText: "-10% to -15%" },
                { range: "> 4.0", minInr: 4.01, maxInr: Infinity, action: "Hold dose, Decrease TWD", minAdj: -0.20, maxAdj: -0.15, hold: "Hold 1-2 doses", vitK: "Consider Oral Vit. K", adjustmentText: "-15% to -20%" }
            ],
            accp: [
                { range: "< 2.0", minInr: 0, maxInr: 1.99, action: "Increase TWD", minAdj: 0.05, maxAdj: 0.15, hold: null, vitK: null, adjustmentText: "+5% to +15%" },
                { range: "2.0 - 3.0", minInr: 2.0, maxInr: 3.0, action: "Continue current dose", minAdj: 0, maxAdj: 0, hold: null, vitK: null, adjustmentText: "0%" },
                { range: "3.1 - 4.0", minInr: 3.1, maxInr: 4.0, action: "Decrease TWD", minAdj: -0.15, maxAdj: -0.05, hold: "Consider holding 1 dose", vitK: null, adjustmentText: "-5% to -15%" },
                { range: "> 4.0", minInr: 4.01, maxInr: Infinity, action: "Hold dose(s), Decrease TWD", minAdj: -0.20, maxAdj: -0.10, hold: "Hold 1-2 doses", vitK: (inr) => inr > 10 ? "Administer Oral Vitamin K (2.5-5mg)" : (inr > 4.5 ? "Consider Oral Vitamin K (1-2.5mg) if high bleed risk" : null), adjustmentText: "-10% to -20%" }
            ]
        };

        function updateInrReferenceTable() {
            const guidelineKey = document.querySelector('input[name="guideline"]:checked').value;
            const tableBody = document.getElementById('inrReferenceTable');
            const data = guidelines[guidelineKey];
            
            tableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 transition-colors';
                let actionText = row.action;
                if (row.hold) actionText += ` (${row.hold})`;
                let vitKText = typeof row.vitK === 'string' ? row.vitK : (typeof row.vitK === 'function' ? 'Consider Oral Vit. K based on INR & risk' : '');

                tr.innerHTML = `
                    <td class="p-3 font-medium opacity-90">${row.range}</td>
                    <td class="p-3">${actionText} ${vitKText ? `<br><span class='text-sm' style='color: var(--accent-color)'>${vitKText}</span>` : ''}</td>
                    <td class="p-3 font-mono font-bold">${row.adjustmentText}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function calculateInrAdjustment() {
            const inr = parseFloat(document.getElementById('currentInr').value);
            const twd = parseFloat(document.getElementById('currentTwd').value);
            const guidelineKey = document.querySelector('input[name="guideline"]:checked').value;
            const resultEl = document.getElementById('inrResult');
            const holdDoseLine = document.getElementById('inrHoldDoseLine');
            const holdDoseSpan = document.getElementById('inrHoldDose');

            if (isNaN(inr) || isNaN(twd) || inr <= 0 || twd <= 0) {
                showModal("Please enter a valid Current INR and Total Weekly Dose.");
                resultEl.style.display = 'none';
                return;
            }

            const guideline = guidelines[guidelineKey];
            const rule = guideline.find(r => inr >= r.minInr && inr <= r.maxInr);

            if (!rule) {
                showModal("Could not find a matching guideline for the entered INR.");
                return;
            }

            let vitKRec = null;
            if (typeof rule.vitK === 'function') {
                vitKRec = rule.vitK(inr);
            } else if (typeof rule.vitK === 'string') {
                vitKRec = rule.vitK;
            }

            const minNewTwd = twd * (1 + rule.minAdj);
            const maxNewTwd = twd * (1 + rule.maxAdj);
            const avgNewTwd = (minNewTwd + maxNewTwd) / 2;
            const suggestedTwd = Math.round(avgNewTwd * 2) / 2; // Round to nearest 0.5

            document.getElementById('inrAction').textContent = `${rule.action}${vitKRec ? ` - ${vitKRec}` : ''}`;
            
            if (rule.hold) {
                holdDoseSpan.textContent = rule.hold;
                holdDoseLine.classList.remove('hidden');
            } else {
                holdDoseLine.classList.add('hidden');
            }

            document.getElementById('newTwdRange').textContent = `${minNewTwd.toFixed(2)} - ${maxNewTwd.toFixed(2)}`;
            document.getElementById('suggestedNewTwd').textContent = suggestedTwd.toFixed(1);
            
            const applyBtn = document.getElementById('applyNewTwdBtn');
            applyBtn.onclick = () => {
                document.getElementById('twdInput').value = suggestedTwd.toFixed(1);
                switchTab('warfarin');
                switchWarfarinTab('twd');
                distributeTWD();
            };

            resultEl.style.display = 'block';
        }

        // --- INITIALIZE VIEWS ---
        document.addEventListener('DOMContentLoaded', () => {
            updateInrReferenceTable();
        });

    </script>
</body>
</html>
