<!DOCTYPE html>
<html lang="en" data-theme="neon">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Universal Clinical Guidance Console v4.1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rajdhani:wght@500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --transition-speed: 0.5s;
        }

        /* ANIMATIONS */
        @keyframes breathe {
            0% { filter: brightness(1) hue-rotate(0deg) saturate(1); transform: scale(1); }
            50% { filter: brightness(1.15) hue-rotate(5deg) saturate(1.2); transform: scale(1.02); }
            100% { filter: brightness(1) hue-rotate(0deg) saturate(1); transform: scale(1); }
        }

        @keyframes grid-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        @keyframes pearl-shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes pulse-border {
            0% { border-color: rgba(var(--accent-primary-rgb), 0.3); box-shadow: 0 0 5px rgba(var(--accent-primary-rgb), 0.1); }
            50% { border-color: rgba(var(--accent-primary-rgb), 0.8); box-shadow: 0 0 15px rgba(var(--accent-primary-rgb), 0.4); }
            100% { border-color: rgba(var(--accent-primary-rgb), 0.3); box-shadow: 0 0 5px rgba(var(--accent-primary-rgb), 0.1); }
        }

        @keyframes float-slow {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, 30px) rotate(5deg); }
            100% { transform: translate(-10px, -20px) rotate(-5deg); }
        }

        /* THEME 1: NEON AURORA */
        [data-theme="neon"] {
            --bg-body: #09090b;
            --bg-panel: rgba(24, 24, 27, 0.75);
            --bg-input: rgba(39, 39, 42, 0.6);
            --border-color: rgba(161, 161, 170, 0.2);
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --accent-primary: #22d3ee; /* Cyan */
            --accent-secondary: #a855f7; /* Purple */
            --accent-primary-rgb: 34, 211, 238;
            --font-head: 'Rajdhani', sans-serif;
            --aurora-opacity: 0.8;
            --grid-opacity: 0.05;
            --anim-grid: none;
            --anim-bg: none;
        }

        /* THEME 2: OBSIDIAN GRID */
        [data-theme="obsidian"] {
            --bg-body: #020617;
            --bg-panel: rgba(15, 23, 42, 0.85);
            --bg-input: #1e293b;
            --border-color: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-primary: #3b82f6; /* Blue */
            --accent-secondary: #cbd5e1; /* Silver */
            --accent-primary-rgb: 59, 130, 246;
            --font-head: 'Inter', sans-serif;
            --aurora-opacity: 0.1;
            --grid-opacity: 0.25;
            --anim-grid: grid-pan 60s linear infinite;
            --anim-bg: none;
        }

        /* THEME 3: GOLD PEARL */
        [data-theme="pearl"] {
            --bg-body: #fdf4ff;
            --bg-panel: rgba(255, 255, 255, 0.9);
            --bg-input: #ffffff;
            --border-color: #e5e7eb;
            --text-main: #4a044e;
            --text-muted: #a21caf; /* Lighter violet for placeholder */
            --accent-primary: #d946ef; /* Fuschia */
            --accent-secondary: #d97706; /* Gold */
            --accent-primary-rgb: 217, 70, 239;
            --font-head: 'Sarabun', sans-serif;
            --aurora-opacity: 0.4;
            --grid-opacity: 0.03;
            --anim-grid: none;
            --anim-bg: pearl-shimmer 15s ease infinite;
        }

        /* --- GLOBAL STYLES --- */
        body {
            font-family: 'Inter', 'Sarabun', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: all var(--transition-speed);
            overflow: hidden;
            background-size: 400% 400%; /* For pearl shimmer */
            animation: var(--anim-bg);
        }
        
        /* Pearl specific background gradient override on body tag */
        [data-theme="pearl"] body {
            background: linear-gradient(-45deg, #fdf4ff, #fae8ff, #f5d0fe, #fdf4ff);
            background-size: 400% 400%;
        }

        h1, h2, h3, h4, h5 { font-family: var(--font-head); }

        /* Background Effects */
        .bg-layer { position: fixed; inset: 0; z-index: -1; pointer-events: none; transition: opacity 1s ease; }
        
        .aurora-blob {
            position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.5;
            animation: float-slow 20s infinite ease-in-out alternate, breathe 8s infinite ease-in-out;
        }
        .blob-1 { top: -20%; left: -20%; width: 70vw; height: 70vw; background: var(--accent-primary); }
        .blob-2 { bottom: -20%; right: -20%; width: 80vw; height: 80vw; background: var(--accent-secondary); animation-delay: -5s; }
        
        .grid-bg {
            background-size: 50px 50px;
            background-image: linear-gradient(to right, var(--accent-primary) 1px, transparent 1px),
                              linear-gradient(to bottom, var(--accent-primary) 1px, transparent 1px);
            opacity: var(--grid-opacity);
            transform: perspective(800px) rotateX(15deg) scale(1.5);
            transform-origin: top center;
            animation: var(--anim-grid);
        }

        /* --- COMPONENT STYLES --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .glass-panel:hover {
            border-color: rgba(var(--accent-primary-rgb), 0.4);
            box-shadow: 0 0 20px rgba(var(--accent-primary-rgb), 0.15);
        }

        .input-tech {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 0.5rem;
            padding: 0.6rem 0.8rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-tech:focus {
            outline: none;
            animation: pulse-border 2s infinite;
            border-color: var(--accent-primary);
        }
        /* Placeholder specific style for "muted" look */
        .input-tech.placeholder-active {
            color: var(--text-muted);
            font-style: italic;
        }

        .btn-tech {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(var(--accent-primary-rgb), 0.3);
            position: relative;
            overflow: hidden;
        }
        .btn-tech:hover {
            box-shadow: 0 0 20px rgba(var(--accent-primary-rgb), 0.6);
            transform: translateY(-1px) scale(1.02);
        }
        .btn-tech-outline {
            background: transparent;
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-tech-outline:hover { background: rgba(var(--accent-primary-rgb), 0.1); }
        
        .nav-item {
            display: flex; align-items: center; padding: 0.75rem 1rem;
            border-radius: 0.5rem; color: var(--text-muted);
            transition: all 0.2s; cursor: pointer;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(var(--accent-primary-rgb), 0.1);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }

        /* Table Styles */
        .tech-table th { padding: 0.75rem; text-align: left; color: var(--accent-primary); border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        .tech-table td { padding: 0.75rem; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: top; font-size: 0.85rem; }
        .tech-table tr:hover { background-color: rgba(var(--accent-primary-rgb), 0.05); }

        /* ABG Formula Specific */
        .result-card { background-color: var(--bg-input); border-left: 4px solid var(--accent-primary); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .result-card h4 { color: var(--accent-primary); font-weight: 600; }
        .formula { font-family: monospace; background-color: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.25rem; color: var(--text-main); font-size: 0.8rem; margin-top: 0.5rem; white-space: pre-wrap; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Toast - Enhanced Readability & Positioning */
        #copy-alert {
            position: fixed; bottom: 20px; right: 20px; z-index: 10000; 
            background: var(--bg-panel); 
            border: 1px solid var(--accent-primary);
            color: var(--text-main); /* Uses theme text color explicitly */
            padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 0.5rem;
            max-width: 80vw; width: auto; min-width: 300px;
            transform: translateY(150%); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(20px);
            word-break: break-word; white-space: pre-wrap;
        }
        #copy-alert.show { transform: translateY(0); opacity: 1; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden text-sm md:text-base">

    <!-- Background Layers -->
    <div class="bg-layer" style="opacity: var(--aurora-opacity);">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
    </div>
    <div class="bg-layer grid-bg"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 glass-panel flex flex-col m-2 h-[calc(100vh-1rem)] transform transition-transform duration-300 -translate-x-full md:translate-x-0 absolute md:relative z-30">
        <div class="p-6 border-b border-[var(--border-color)] flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="ph-fill ph-asterisk-simple text-3xl" style="color: var(--accent-primary)"></i>
                <div>
                    <h1 class="text-xl font-bold leading-none tracking-wider">MED-OS</h1>
                    <span class="text-[10px] text-[var(--text-muted)] tracking-widest uppercase">Clinical V.4.1</span>
                </div>
            </div>
            <button id="close-sidebar" class="md:hidden text-[var(--text-muted)]"><i class="ph ph-x text-2xl"></i></button>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-1">
            <div class="nav-item active" data-target="orders"><i class="ph ph-pill text-xl mr-3"></i> ICU Orders</div>
            <div class="nav-item" data-target="abg"><i class="ph ph-flask text-xl mr-3"></i> ABG Analysis</div>
            <div class="nav-item" data-target="betablocker"><i class="ph ph-heartbeat text-xl mr-3"></i> Beta-Blocker</div>
            <div class="nav-item" data-target="calcium"><i class="ph ph-atom text-xl mr-3"></i> Calcium Calc</div>
            <div class="nav-item" data-target="calsulin"><i class="ph ph-drop text-xl mr-3"></i> Insulin Dosing</div>
            <div class="nav-item" data-target="nutrition"><i class="ph ph-bowl-food text-xl mr-3"></i> Nutrition Note</div>
            <div class="nav-item" data-target="steroid"><i class="ph ph-shield-plus text-xl mr-3"></i> Steroid Equiv.</div>
        </nav>

        <div class="p-4 border-t border-[var(--border-color)]">
            <div class="text-[10px] text-[var(--text-muted)] text-center font-mono">
                Wasupon Srisatit, MD<br>
                Internal Medicine<br>
                Rajavithi Hospital
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen relative z-10">
        <!-- Header -->
        <header class="glass-panel m-2 mb-0 p-4 flex justify-between items-center relative z-50">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle" class="md:hidden text-[var(--text-main)]"><i class="ph ph-list text-2xl"></i></button>
                <h2 id="page-title" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-secondary)]">ICU Orders</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <button class="btn-tech-outline flex items-center gap-2 text-xs">
                        <i class="ph ph-paint-brush-broad"></i> Theme
                    </button>
                    <!-- Theme Dropdown: Increased Z-index to 100 -->
                    <div class="absolute right-0 mt-2 w-56 glass-panel shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all transform origin-top-right z-[100]">
                        <div class="p-2 space-y-1">
                            <button onclick="setTheme('neon')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-[var(--accent-primary)] hover:text-black transition-colors flex items-center"><span class="w-3 h-3 rounded-full bg-cyan-400 mr-2 shadow-[0_0_10px_cyan]"></span> Neon Aurora</button>
                            <button onclick="setTheme('obsidian')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-[var(--accent-primary)] hover:text-white transition-colors flex items-center"><span class="w-3 h-3 rounded-full bg-slate-800 border border-slate-500 mr-2"></span> Obsidian Grid</button>
                            <button onclick="setTheme('pearl')" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-[var(--accent-primary)] hover:text-white transition-colors flex items-center"><span class="w-3 h-3 rounded-full bg-fuchsia-200 border border-fuchsia-400 mr-2"></span> Gold Pearl</button>
                            <div class="h-px bg-[var(--border-color)] my-1"></div>
                            <button onclick="setRandomTheme()" class="w-full text-left px-3 py-2 rounded text-sm hover:bg-[var(--accent-primary)] hover:text-black transition-colors flex items-center font-bold"><i class="ph ph-magic-wand mr-2"></i> Quantum Random</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto p-4 space-y-8 pb-20 z-0 relative">

            <!-- PAGE 1: ICU ORDERS -->
            <div id="orders" class="content-page fade-in">
                <!-- Section: Sedation -->
                <section class="space-y-4 mb-8">
                    <h3 class="text-lg font-bold border-b border-[var(--border-color)] pb-2 text-[var(--accent-secondary)]">Sedation & Analgesia</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                        <!-- Cards -->
                        <div class="glass-panel p-4 flex flex-col gap-3 hover:border-[var(--accent-primary)] transition-colors group">
                            <div class="flex justify-between items-start"><h5 class="font-bold group-hover:text-[var(--accent-primary)] transition-colors">Midazolam</h5><i class="ph ph-moon-stars text-[var(--accent-secondary)]"></i></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Conc (ratio)</label><input id="midazolam-concentration" class="input-tech" value="2:1" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="midazolam-rate" class="input-tech" value="5" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="midazolam"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                        <div class="glass-panel p-4 flex flex-col gap-3 hover:border-[var(--accent-primary)] transition-colors group">
                            <div class="flex justify-between items-start"><h5 class="font-bold group-hover:text-[var(--accent-primary)] transition-colors">1% Propofol</h5><i class="ph ph-drop text-[var(--accent-secondary)]"></i></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Conc (ratio)</label><input id="propofol-concentration" class="input-tech" value="10:1" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="propofol-rate" class="input-tech" value="5" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="propofol"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                        <div class="glass-panel p-4 flex flex-col gap-3 hover:border-[var(--accent-primary)] transition-colors group">
                            <div class="flex justify-between items-start"><h5 class="font-bold group-hover:text-[var(--accent-primary)] transition-colors">Dexmedetomidine</h5><i class="ph ph-brain text-[var(--accent-secondary)]"></i></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Conc (ratio)</label><input id="dexmed-concentration" class="input-tech" value="4:1" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="dexmed-rate" class="input-tech" value="10" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="dexmed"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                         <div class="glass-panel p-4 flex flex-col gap-3 hover:border-[var(--accent-primary)] transition-colors group">
                            <div class="flex justify-between items-start"><h5 class="font-bold group-hover:text-[var(--accent-primary)] transition-colors">Fentanyl</h5><i class="ph ph-bandaids text-[var(--accent-secondary)]"></i></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Conc (ratio)</label><input class="input-tech opacity-50" value="10:1" disabled /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="fentanyl-rate" class="input-tech" value="5" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="fentanyl"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                    </div>
                </section>

                <!-- Section: Vent (Original Logic) -->
                <section class="space-y-4 mb-8">
                    <h3 class="text-lg font-bold border-b border-[var(--border-color)] pb-2 text-[var(--accent-secondary)]">Mechanical Ventilation</h3>
                    <div class="glass-panel p-6 max-w-3xl">
                        <h5 class="text-xl font-semibold mb-4">Ventilator Settings</h5>
                        <div class="grid grid-cols-2 md:grid-cols-2 gap-4 mb-4">
                            <div class="col-span-2 md:col-span-2"><label class="text-xs text-[var(--text-muted)]">Mode</label><select id="vent-mode" class="input-tech"><option>VCV</option><option>PCV</option><option>SIMV</option><option>PSV</option></select></div>
                            <div class="vt-field"><label class="text-xs text-[var(--text-muted)]">VT (mL)</label><input id="vent-VT" class="input-tech" value="450" /></div>
                            <div class="ip-field hidden"><label class="text-xs text-[var(--text-muted)]">IP (cmH₂O)</label><input id="vent-IP" class="input-tech" value="20" /></div>
                            <div class="ps-field hidden"><label class="text-xs text-[var(--text-muted)]">PS (cmH₂O)</label><input id="vent-PS" class="input-tech" value="10" /></div>
                            <div class="rr-field"><label class="text-xs text-[var(--text-muted)]">RR (/min)</label><input id="vent-RR" class="input-tech" value="20" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Ti (s)</label><input id="vent-Ti" class="input-tech" value="1.0" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">FT (L/min)</label><input id="vent-FT" class="input-tech" value="2" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">PEEP</label><input id="vent-PEEP" class="input-tech" value="5" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">FiO₂</label><input id="vent-FiO2" class="input-tech" value="0.4" /></div>
                        </div>
                        <button class="btn-tech copy-btn w-full flex justify-center items-center gap-2" data-id="vent"><i class="ph ph-copy"></i> Copy Ventilator Order</button>
                    </div>
                </section>

                <!-- Section: Vaso -->
                <section class="space-y-4 mb-8">
                    <h3 class="text-lg font-bold border-b border-[var(--border-color)] pb-2 text-[var(--accent-secondary)]">Vasopressors</h3>
                    <div class="glass-panel p-4 mb-4 flex items-center gap-4 max-w-md border-l-4 border-[var(--accent-primary)]">
                        <i class="ph ph-scales text-2xl text-[var(--accent-primary)]"></i>
                        <div class="flex-1">
                            <label class="text-xs text-[var(--text-muted)] uppercase tracking-wide font-bold">Patient Body Weight (kg)</label>
                            <input id="vasopressors-weight" type="number" class="input-tech text-lg font-bold text-[var(--accent-primary)]" placeholder="e.g. 70" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                         <!-- Norepi -->
                         <div class="glass-panel p-4 flex flex-col gap-3 group">
                            <h5 class="font-bold text-[var(--accent-primary)]">Norepinephrine</h5>
                            <div class="norepi-btn-group grid grid-cols-2 gap-2 text-xs">
                                <button class="btn-tech-outline preset-btn" data-ratio="4:250">4:250</button>
                                <button class="btn-tech-outline preset-btn" data-ratio="4:100">4:100</button>
                                <button class="btn-tech-outline preset-btn" data-ratio="8:100">8:100</button>
                                <button class="btn-tech-outline preset-btn" data-ratio="16:100">16:100</button>
                            </div>
                            <input type="hidden" id="norepi-concentration" value="4:250">
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="norepi-rate" class="input-tech" placeholder="20" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Titration (ml/hr)</label><input id="norepi-titrate" class="input-tech" value="1-2" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="norepi"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                        <!-- Epi -->
                        <div class="glass-panel p-4 flex flex-col gap-3 group">
                            <h5 class="font-bold text-[var(--accent-primary)]">Epinephrine</h5>
                            <div class="epi-btn-group text-xs">
                                <button class="btn-tech-outline preset-btn w-full" data-ratio="1:10">1:10</button>
                            </div>
                            <input type="hidden" id="epi-concentration" value="1:10">
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="epi-rate" class="input-tech" placeholder="10" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Titration (ml/hr)</label><input id="epi-titrate" class="input-tech" value="1-2" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="epi"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                        <!-- Dopamine -->
                        <div class="glass-panel p-4 flex flex-col gap-3 group">
                            <h5 class="font-bold text-[var(--accent-primary)]">Dopamine</h5>
                            <div class="dopamine-btn-group text-xs"><button class="btn-tech-outline preset-btn w-full" data-ratio="2:1">2:1</button></div>
                            <input type="hidden" id="dopamine-concentration" value="2:1">
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="dopamine-rate" class="input-tech" placeholder="15" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="dopamine"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                         <!-- Dobutamine -->
                         <div class="glass-panel p-4 flex flex-col gap-3 group">
                            <h5 class="font-bold text-[var(--accent-primary)]">Dobutamine</h5>
                            <div class="dobutamine-btn-group text-xs"><button class="btn-tech-outline preset-btn w-full" data-ratio="2:1">2:1</button></div>
                            <input type="hidden" id="dobutamine-concentration" value="2:1">
                            <div><label class="text-xs text-[var(--text-muted)]">Rate (mL/hr)</label><input id="dobutamine-rate" class="input-tech" placeholder="10" /></div>
                            <button class="btn-tech mt-auto copy-btn w-full flex justify-center items-center gap-2" data-id="dobutamine"><i class="ph ph-copy"></i> Copy Order</button>
                        </div>
                    </div>
                </section>

                <!-- Section: Enteral (BD Feed) -->
                <section class="space-y-4 mb-8">
                    <h3 class="text-lg font-bold border-b border-[var(--border-color)] pb-2 text-[var(--accent-secondary)]">Enteral Nutrition</h3>
                    <div class="glass-panel p-4 max-w-lg">
                        <h5 class="font-bold mb-4">BD Feed Order</h5>
                        <div class="space-y-2">
                            <div><label class="text-xs text-[var(--text-muted)]">Concentration (ratio)</label><input id="bd_feed-concentration" class="input-tech" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Volume (mL)</label><input id="bd_feed-volume" class="input-tech" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Feeds/day</label><input id="bd_feed-frequency" class="input-tech" value="4" /></div>
                            <div><label class="text-xs text-[var(--text-muted)]">Flush Vol (mL)</label><input id="bd_feed-flush" class="input-tech" /></div>
                        </div>
                        <button class="btn-tech mt-4 copy-btn w-full flex justify-center items-center gap-2" data-id="bd_feed"><i class="ph ph-copy"></i> Copy Feed Order</button>
                    </div>
                </section>

                <!-- Section: Antibiotics & Renal -->
                <section class="space-y-4 mb-8">
                     <h3 class="text-lg font-bold border-b border-[var(--border-color)] pb-2 text-[var(--accent-secondary)]">Antibiotics & Renal Dosing</h3>
                     <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                        <!-- CrCl Calc -->
                        <div class="lg:col-span-2 glass-panel p-6 space-y-4">
                            <h5 class="font-bold flex items-center gap-2"><i class="ph ph-calculator text-[var(--accent-primary)]"></i> Cockcroft-Gault CrCl</h5>
                            <div class="space-y-4">
                                <div><label class="text-xs text-[var(--text-muted)]">Age (years)</label><input id="crcl-age" type="number" class="input-tech" placeholder="e.g., 65"></div>
                                <div><label class="text-xs text-[var(--text-muted)]">Weight (kg)</label><input id="crcl-weight" type="number" class="input-tech" placeholder="e.g., 70"></div>
                                <div><label class="text-xs text-[var(--text-muted)]">Serum Creatinine (mg/dL)</label><input id="crcl-creatinine" type="number" class="input-tech" placeholder="e.g., 1.2"></div>
                                <div><label class="text-xs text-[var(--text-muted)]">Sex</label><select id="crcl-sex" class="input-tech"><option value="male">Male</option><option value="female">Female</option></select></div>
                            </div>
                            <button id="calculate-crcl-btn" class="btn-tech w-full">Calculate CrCl</button>
                            <div id="crcl-result" class="text-center text-3xl font-bold text-[var(--accent-primary)] py-2"></div>
                        </div>

                        <!-- ATB Dosing -->
                         <div class="lg:col-span-3 glass-panel p-6 space-y-4">
                            <h5 class="font-bold flex items-center gap-2"><i class="ph ph-virus text-[var(--accent-primary)]"></i> Antibiotic Dosing Guide</h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-xs text-[var(--text-muted)]">Antibiotic</label><select id="atb-select" class="input-tech"><option selected disabled>Select an Antibiotic...</option><option value="Meropenem">Meropenem</option><option value="Piperacillin/Tazobactam">Piperacillin/Tazobactam</option><option value="Levofloxacin">Levofloxacin</option><option value="Ceftazidime">Ceftazidime</option><option value="Imipenem/Cilastatin">Imipenem/Cilastatin</option><option value="IV Fosfomycin">IV Fosfomycin</option><option value="Colistin">Colistin</option></select></div>
                                <div><label class="text-xs text-[var(--text-muted)]">Dose Tier / Indication</label><select id="atb-dose-tier" class="input-tech"></select></div>
                                <div id="pathogen-container" class="hidden"><label class="text-xs text-[var(--text-muted)]">Pathogen</label><select id="atb-pathogen" class="input-tech"></select></div>
                                <div><label class="text-xs text-[var(--text-muted)]">CrCl (mL/min)</label><input id="atb-crcl" type="number" class="input-tech bg-opacity-20" readonly></div>
                                <div class="md:col-span-2"><label class="text-xs text-[var(--text-muted)]">RRT Modality</label><select id="atb-rrt" class="input-tech"><option value="none" selected>None</option><option value="IHD">Hemodialysis (IHD)</option><option value="PD">Peritoneal Dialysis (PD)</option><option value="CRRT_II">CRRT (Intermittent Infusion)</option><option value="CRRT_CI">CRRT (Continuous Infusion)</option><option value="PIRRT_SLED">PIRRT / SLED</option></select></div>
                            </div>
                            <div class="flex gap-3 mt-4">
                                <button id="calculate-atb-dose-btn" class="btn-tech flex-1">Calculate Maintenance Dose</button>
                                <button id="show-loading-dose-btn" class="btn-tech-outline flex-1">Show Loading Dose</button>
                            </div>
                            <div id="atb-dose-result" class="p-4 rounded border border-[var(--border-color)] bg-[var(--bg-input)] min-h-[5.5rem] text-sm flex items-center justify-center text-center font-mono font-bold text-lg"></div>
                         </div>
                     </div>
                     <!-- Full Reference Table -->
                     <h3 class="text-xl font-semibold mb-4 mt-8">Antibiotic Reference Table</h3>
                     <div class="glass-panel p-4 mt-4 overflow-x-auto">
                        <table class="w-full text-sm text-left tech-table">
                            <thead class="text-[var(--accent-primary)] font-bold">
                                <tr><th class="whitespace-nowrap">Antibiotic</th><th>Indication / Dose Tier</th><th>Loading Dose</th><th>CrCl (mL/min) or RRT Modality</th><th>Adjusted Maintenance Dose & Regimen</th></tr>
                            </thead>
                            <tbody id="atb-reference-tbody" class="text-[var(--text-main)] opacity-90 text-xs"></tbody>
                        </table>
                     </div>
                </section>
            </div>

            <!-- PAGE 2: ABG -->
            <div id="abg" class="content-page hidden fade-in max-w-4xl mx-auto">
                <div class="glass-panel p-8 space-y-6">
                    <div class="text-center">
                        <i class="ph ph-lungs text-4xl text-[var(--accent-primary)] animate-pulse"></i>
                        <h2 class="text-3xl font-bold mt-2">ABG Analysis Calculator</h2>
                        <p class="text-[var(--text-muted)] mt-1 text-sm">Comprehensive Acid-Base Evaluation</p>
                    </div>
                    
                    <div id="abgErrorMessage" class="hidden p-3 bg-red-900/50 border border-red-500 text-red-200 rounded text-sm text-center">
                        <span class="font-bold">Error:</span> <span id="abgErrorMessageText"></span>
                    </div>

                    <h2 class="text-lg font-semibold text-[var(--accent-secondary)] border-b border-[var(--border-color)] pb-2">Patient Data</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                        <div><label class="text-xs text-[var(--text-muted)] font-bold">pH *</label><input id="ph" type="number" step="0.01" class="input-tech" placeholder="e.g. 7.25"></div>
                        <div><label class="text-xs text-[var(--text-muted)] font-bold">PaCO₂ (mmHg) *</label><input id="paco2" type="number" class="input-tech text-lg" placeholder="e.g. 25"></div>
                        <div><label class="text-xs text-[var(--text-muted)] font-bold">HCO₃⁻ (mEq/L) *</label><input id="hco3" type="number" class="input-tech text-lg" placeholder="e.g. 12"></div>
                        <div><label class="text-xs text-[var(--text-muted)]">Na⁺ (Optional)</label><input id="na" type="number" class="input-tech" placeholder="e.g. 140"></div>
                        <div><label class="text-xs text-[var(--text-muted)]">Cl⁻ (Optional)</label><input id="cl" type="number" class="input-tech" placeholder="e.g. 100"></div>
                        <div><label class="text-xs text-[var(--text-muted)]">Albumin (Optional)</label><input id="albumin" type="number" step="0.1" class="input-tech" placeholder="e.g. 4.0"></div>
                    </div>

                    <div id="respiratoryTiming" class="hidden p-4 border border-[var(--border-color)] rounded bg-[var(--bg-input)]">
                        <h3 class="text-md font-semibold mb-2">Respiratory Disorder Timing</h3>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center mr-4 cursor-pointer"><input type="radio" name="timing" value="acute" class="mr-2 accent-[var(--accent-primary)]"> Acute</label>
                            <label class="inline-flex items-center cursor-pointer"><input type="radio" name="timing" value="chronic" class="mr-2 accent-[var(--accent-primary)]"> Chronic (>72 hrs)</label>
                        </div>
                    </div>

                    <button onclick="analyzeABG()" class="btn-tech w-full py-3 text-lg tracking-widest uppercase shadow-lg">Analyze ABG</button>

                    <div id="abgResultsSection" class="hidden space-y-4 pt-4 border-t border-[var(--border-color)]">
                        <h2 class="text-xl font-bold text-white border-b border-[var(--border-color)] pb-2">Analysis Results</h2>
                        <div id="primaryDisorderResult"></div>
                        <div id="anionGapResult"></div>
                        <div id="compensationResult"></div>
                        <div class="glass-panel p-4 border border-[var(--accent-secondary)] bg-[var(--accent-secondary)]/5">
                            <h4 class="font-bold text-[var(--accent-secondary)] uppercase text-sm mb-2">Final Interpretation</h4>
                            <p id="summaryText" class="text-lg font-medium"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: BETA BLOCKER -->
            <div id="betablocker" class="content-page hidden fade-in max-w-3xl mx-auto">
                 <div class="glass-panel p-8 space-y-6">
                    <h2 class="text-2xl font-bold flex items-center gap-3"><i class="ph ph-heart-break text-[var(--accent-primary)]"></i> Beta-Blocker Equivalence Calculator</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-[var(--text-muted)]">Convert From</label>
                            <select id="bb_drug" class="input-tech">
                                <option value="atenolol">Atenolol</option>
                                <option value="bisoprolol">Bisoprolol</option>
                                <option value="carvedilol">Carvedilol</option>
                                <option value="metoprolol_t" selected>Metoprolol Tartrate</option>
                                <option value="metoprolol_s">Metoprolol Succinate (ER)</option>
                                <option value="nebivolol">Nebivolol</option>
                                <option value="propranolol">Propranolol</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-[var(--text-muted)]">Total Daily Dose (mg)</label>
                            <input type="number" id="bb_dose" class="input-tech" placeholder="e.g. 100">
                        </div>
                    </div>
                    <button onclick="calculateBetaBlockerEquivalence()" class="btn-tech w-full">Calculate</button>
                    
                    <div id="bbErrorMessage" class="hidden text-red-400 text-center"></div>
                    <div id="bbResultsSection" class="hidden space-y-2 pt-4">
                        <h4 class="text-[var(--accent-secondary)] font-bold uppercase tracking-wider text-sm mb-2">Equivalent Daily Doses</h4>
                        <div id="bbResultsList" class="space-y-2"></div>
                    </div>

                    <div class="mt-8 pt-4 border-t border-[var(--border-color)]">
                        <h4 class="text-lg font-bold text-[var(--text-muted)] mb-4">Guideline-Directed Beta-Blocker Dosing for HFrEF</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs tech-table">
                                <thead class="text-[var(--accent-primary)]">
                                    <tr><th class="p-2 text-left">Beta-Blocker</th><th class="p-2 text-left">Starting Dose</th><th class="p-2 text-left">Target Dose</th></tr>
                                </thead>
                                <tbody class="text-[var(--text-main)] opacity-80">
                                    <tr><td class="p-2 font-bold">Bisoprolol</td><td class="p-2">1.25 mg once daily</td><td class="p-2">10 mg once daily</td></tr>
                                    <tr><td class="p-2 font-bold">Carvedilol</td><td class="p-2">3.125 mg twice daily</td><td class="p-2">25 mg twice daily<br>(50 mg twice daily if weight > 85 kg)</td></tr>
                                    <tr><td class="p-2 font-bold">Metoprolol Succinate (ER)</td><td class="p-2">12.5 - 25 mg once daily</td><td class="p-2">200 mg once daily</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- PAGE 4: CALCIUM -->
            <div id="calcium" class="content-page hidden fade-in max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Corrected Ca -->
                    <div class="glass-panel p-6 space-y-4">
                        <h3 class="text-lg font-bold text-[var(--accent-primary)]">Corrected Calcium (cCa)</h3>
                        <div><label class="text-xs text-[var(--text-muted)]">Total Calcium (mg/dL)</label><input type="number" id="totalCalcium" class="input-tech" placeholder="e.g. 8.5"></div>
                        <div><label class="text-xs text-[var(--text-muted)]">Albumin (g/dL)</label><input type="number" id="albumin_ca" class="input-tech" placeholder="e.g. 3.0"></div>
                        <button onclick="calculateCorrectedCalcium()" class="btn-tech w-full">Calculate cCa</button>
                        <div id="caErrorMessage" class="hidden text-red-400 text-xs"></div>
                        <div id="correctedCalciumResult" class="hidden p-3 bg-[var(--bg-input)] rounded border-l-4 border-[var(--accent-primary)] font-bold text-center text-xl"></div>
                    </div>

                    <!-- Infusion Calc -->
                    <div class="glass-panel p-6 space-y-4">
                        <h3 class="text-lg font-bold text-[var(--accent-secondary)]">Calcium Gluconate Infusion</h3>
                        <div class="space-y-3">
                            <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">Infusion Rate (mg/kg/hr)</label><input id="infusion_rate" type="number" class="input-tech h-8 text-sm"></div>
                                <button onclick="calculateInfusion('rate')" class="btn-tech-outline h-8 px-2 text-xs">Calc</button>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">Patient Weight (kg)</label><input id="infusion_weight" type="number" class="input-tech h-8 text-sm"></div>
                                <button onclick="calculateInfusion('weight')" class="btn-tech-outline h-8 px-2 text-xs">Calc</button>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">10% Ca Gluconate (mL)</label><input id="infusion_caVolume" type="number" class="input-tech h-8 text-sm"></div>
                                <button onclick="calculateInfusion('caVolume')" class="btn-tech-outline h-8 px-2 text-xs">Calc</button>
                            </div>
                             <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">Diluent Volume (mL)</label><input id="infusion_ivVolume" type="number" class="input-tech h-8 text-sm"></div>
                                <button onclick="calculateInfusion('ivVolume')" class="btn-tech-outline h-8 px-2 text-xs">Calc</button>
                            </div>
                             <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">Total Fluid Volume (mL)</label><input id="infusion_totalVolume" type="number" class="input-tech h-8 text-sm bg-transparent border-dashed"></div>
                            </div>
                             <div class="flex gap-2 items-end">
                                <div class="flex-1"><label class="text-[10px] text-[var(--text-muted)]">IV Drip Rate (mL/hr)</label><input id="infusion_dripRate" type="number" class="input-tech h-8 text-sm"></div>
                                <button onclick="calculateInfusion('dripRate')" class="btn-tech-outline h-8 px-2 text-xs">Calc</button>
                            </div>
                        </div>
                        <button id="toggleDurationBtn" onclick="toggleDurationSection()" class="text-xs text-[var(--accent-primary)] underline w-full text-center">Show Infusion Duration Calculator</button>
                        <div id="durationSection" class="hidden pt-2 border-t border-[var(--border-color)] grid grid-cols-3 gap-2">
                             <div><label class="text-[10px]">Total Vol</label><input id="duration_totalVolume" class="input-tech h-8 text-xs"></div>
                             <div><label class="text-[10px]">Drip Rate</label><input id="duration_dripRate" class="input-tech h-8 text-xs"></div>
                             <div><label class="text-[10px]">Time (hrs)</label><input id="duration_time" class="input-tech h-8 text-xs"></div>
                             <button onclick="calculateDuration('time')" class="col-span-3 btn-tech-outline h-6 text-xs mt-1">Calc</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 5: INSULIN -->
            <div id="calsulin" class="content-page hidden fade-in max-w-5xl mx-auto">
                <div class="glass-panel p-6">
                    <header class="flex justify-between items-center mb-6 border-b border-[var(--border-color)] pb-4">
                        <div>
                            <h2 class="text-2xl font-bold">In-Patient Insulin Dosing Tool</h2>
                            <p class="text-[var(--text-muted)] text-sm">Initial Dosing, Titration, and Correction.</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="calsulin-step1-btn" onclick="showCalsulinTab('step1')" class="btn-tech text-sm">Step 1: Initial Dose</button>
                            <button id="calsulin-step2-btn" onclick="showCalsulinTab('step2')" class="btn-tech-outline text-sm">Step 2: Titration Order</button>
                            <button id="calsulin-step3-btn" onclick="showCalsulinTab('step3')" class="btn-tech-outline text-sm">Step 3: Correction Dose</button>
                        </div>
                    </header>

                    <!-- Step 1 -->
                    <div id="calsulin-step1" class="tab-content block">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <h4 class="text-[var(--accent-primary)] font-bold">1. Patient & Dose Information</h4>
                                <div class="p-3 border border-[var(--border-color)] rounded bg-[var(--bg-input)]">
                                    <label class="block text-xs font-bold mb-2">TDD Calculation Method</label>
                                    <div class="flex gap-4 mb-2">
                                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" name="tddMethod" value="calculate" checked class="mr-2 accent-[var(--accent-primary)]"> Calculate from BW</label>
                                        <label class="flex items-center text-sm cursor-pointer"><input type="radio" name="tddMethod" value="manual" class="mr-2 accent-[var(--accent-primary)]"> Enter TDD Manually</label>
                                    </div>
                                    <div id="calculationInputs" class="space-y-2">
                                        <input type="number" id="bodyWeight" class="input-tech" placeholder="Body Weight (kg)">
                                        <div class="flex gap-2">
                                            <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center text-xs cursor-pointer hover:bg-[var(--accent-primary)] hover:text-white transition"><input type="radio" name="tddUnit" value="0.4" class="hidden">0.4 U/kg</label>
                                            <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center text-xs cursor-pointer bg-[var(--accent-primary)] text-black font-bold transition"><input type="radio" name="tddUnit" value="0.5" checked class="hidden">0.5 U/kg</label>
                                            <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center text-xs cursor-pointer hover:bg-[var(--accent-primary)] hover:text-white transition"><input type="radio" name="tddUnit" value="0.6" class="hidden">0.6 U/kg</label>
                                        </div>
                                    </div>
                                    <div id="manualTddInput" class="hidden"><input type="number" id="manualTdd" class="input-tech" placeholder="Total Daily Dose (TDD)"></div>
                                </div>

                                <div class="p-3 border border-[var(--border-color)] rounded bg-[var(--bg-input)]">
                                    <label class="block text-xs font-bold mb-2">Insulin Regimen</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center p-2 rounded hover:bg-white/5 cursor-pointer"><input type="radio" name="feedingFrequency" value="3meals" class="mr-2 accent-[var(--accent-primary)]"> 3 Meals/Day (Self-eating) - RI + NPH</label>
                                        <label class="flex items-center p-2 rounded hover:bg-white/5 cursor-pointer"><input type="radio" name="feedingFrequency" value="4meals" class="mr-2 accent-[var(--accent-primary)]"> 4 Feeds/Day (Tube-feeding) - RI + NPH</label>
                                        <label class="flex items-center p-2 rounded hover:bg-white/5 cursor-pointer"><input type="radio" name="feedingFrequency" value="premixed" class="mr-2 accent-[var(--accent-primary)]"> Premixed (e.g., 70/30) - 2 injections/day</label>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-col h-full bg-[var(--bg-input)] rounded border border-[var(--border-color)] p-4 relative overflow-hidden">
                                <div id="noSelectionMessage" class="absolute inset-0 flex items-center justify-center text-[var(--text-muted)] text-sm">Please enter patient data and select a regimen.</div>
                                <div id="calsulin-resultsContent" class="hidden space-y-4 z-10 h-full flex flex-col">
                                    <h4 class="text-[var(--accent-primary)] font-bold">2. Calculated Insulin Regimen</h4>
                                    <div class="grid grid-cols-3 gap-2 text-center">
                                        <div class="p-2 bg-[var(--accent-secondary)]/20 rounded border border-[var(--accent-secondary)]">
                                            <div class="text-[10px] uppercase">Total Daily Dose</div>
                                            <div id="tddResult" class="text-xl font-bold text-[var(--accent-secondary)]">- U</div>
                                        </div>
                                        <div class="p-2 bg-[var(--accent-primary)]/20 rounded border border-[var(--accent-primary)]">
                                            <div class="text-[10px] uppercase">Total Bolus</div>
                                            <div id="bolusResult" class="text-xl font-bold text-[var(--accent-primary)]">- U</div>
                                        </div>
                                        <div class="p-2 bg-yellow-500/20 rounded border border-yellow-500">
                                            <div class="text-[10px] uppercase">Total Basal</div>
                                            <div id="basalResult" class="text-xl font-bold text-yellow-500">- U</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex-1">
                                        <h5 class="text-xs font-bold mb-1">Daily Schedule:</h5>
                                        <table class="w-full text-xs tech-table">
                                            <thead class="text-left font-bold"><tr><th>Time</th><th>Insulin Type</th><th>Dose (Units)</th></tr></thead>
                                            <tbody id="scheduleBody"></tbody>
                                        </table>
                                    </div>
                                    <div id="calculationText" class="text-[10px] font-mono text-[var(--text-muted)] whitespace-pre-wrap border-t border-[var(--border-color)] pt-2"></div>
                                    <button id="proceedButton" onclick="proceedToStep2()" class="btn-tech w-full">Use these doses in Step 2 &rarr;</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div id="calsulin-step2" class="tab-content hidden">
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-4">
                                <h4 class="text-[var(--accent-primary)] font-bold">1. Baseline Doses for Titration</h4>
                                <div><label class="text-xs text-[var(--text-muted)]">Regimen Type</label><select id="regimenType" class="input-tech"><option value="basalBolus">Basal-Bolus</option><option value="premixed">Premixed (70/30)</option></select></div>
                                <!-- Dynamic Inputs -->
                                <div id="basalBolusInputs">
                                    <div class="flex gap-4 mb-2"><label class="text-xs flex items-center cursor-pointer"><input type="radio" name="feedingSchedule" value="3" checked class="mr-2 accent-[var(--accent-primary)]"> 3 Meals</label><label class="text-xs flex items-center cursor-pointer"><input type="radio" name="feedingSchedule" value="4" class="mr-2 accent-[var(--accent-primary)]"> 4 Feeds</label></div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="basalType" class="input-tech"><option>NPH</option><option>Semglee</option><option>Glargine</option></select>
                                        <input id="basalDose" type="number" class="input-tech" placeholder="Basal Dose (U)">
                                        <select id="bolusType" class="input-tech"><option>RI</option><option>Novorapid</option></select>
                                        <input id="bolusDose" type="number" class="input-tech" placeholder="Bolus Dose (U)">
                                    </div>
                                </div>
                                <div id="premixedInputs" class="hidden grid grid-cols-2 gap-2">
                                    <input type="hidden" id="premixedType" value="NPH (70/30)">
                                    <input id="premixedMorningDose" type="number" class="input-tech" placeholder="Morning Dose (U)">
                                    <input id="premixedEveningDose" type="number" class="input-tech" placeholder="Evening Dose (U)">
                                </div>
                                <div id="validation-message" class="text-red-400 text-xs h-4"></div>
                                <button onclick="generateOrder()" class="btn-tech w-full">Generate / Update Order</button>
                            </div>
                            <div class="bg-[var(--bg-input)] p-4 rounded border border-[var(--border-color)] flex flex-col">
                                <h4 class="text-[var(--accent-primary)] font-bold mb-2">2. Generated Titration Order</h4>
                                <div id="orderOutput" class="text-sm font-mono whitespace-pre-wrap flex-1">Your generated order will appear here.</div>
                                <button id="copyButton" onclick="copyOrderText()" class="btn-tech-outline mt-2 hidden w-full">Copy Order Text</button>
                                <div id="copyFeedback" class="text-center text-xs text-[var(--accent-primary)] h-4 mt-1"></div>
                            </div>
                         </div>
                    </div>
                    
                    <!-- Step 3 Correction -->
                    <div id="calsulin-step3" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <h4 class="text-[var(--accent-primary)] font-bold">1. Patient & Glucose Data</h4>
                                <div class="flex gap-2">
                                    <input id="tddCorrection" type="number" class="input-tech" placeholder="Total Daily Dose (TDD) (units)">
                                    <button onclick="useCalculatedTDD()" class="btn-tech-outline text-xs whitespace-nowrap">Use TDD from Step 1</button>
                                </div>
                                <input id="current-bg" type="number" class="input-tech" placeholder="Current Blood Glucose (mg/dL)">
                                <input id="target-bg" type="number" class="input-tech" value="150" placeholder="Target Blood Glucose (mg/dL)">
                                
                                <div>
                                    <label class="text-xs text-[var(--text-muted)] mb-1 block">Select Insulin Sensitivity Factor (ISF) Rule</label>
                                    <div class="flex gap-2">
                                        <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center cursor-pointer hover:bg-white/5"><input type="radio" name="isf-rule" value="1800" checked class="hidden"><span class="block text-sm font-bold">1800 Rule</span><span class="text-[10px]">Rapid-Acting Analogs</span></label>
                                        <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center cursor-pointer hover:bg-white/5"><input type="radio" name="isf-rule" value="1700" class="hidden"><span class="block text-sm font-bold">1700 Rule</span><span class="text-[10px]">Rapid-Acting (Cons)</span></label>
                                        <label class="flex-1 border border-[var(--border-color)] rounded p-2 text-center cursor-pointer hover:bg-white/5"><input type="radio" name="isf-rule" value="1500" class="hidden"><span class="block text-sm font-bold">1500 Rule</span><span class="text-[10px]">Regular Insulin</span></label>
                                    </div>
                                </div>
                                <button id="calculate-correction-btn" class="btn-tech w-full">Calculate Correction Dose</button>
                                <div id="calsulin-error-message" class="text-red-400 text-xs h-4"></div>
                            </div>
                            <div id="calsulin-results-container" class="bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)] rounded p-6 flex flex-col justify-center items-center text-center">
                                <h4 class="text-[var(--accent-primary)] font-bold mb-4">2. Calculation Breakdown</h4>
                                <div id="results-content-correction" class="text-[var(--text-muted)]">Results will be displayed here.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 6: NUTRITION -->
            <div id="nutrition" class="content-page hidden fade-in max-w-4xl mx-auto">
                <div class="glass-panel p-8">
                    <h2 class="text-2xl font-bold text-[var(--accent-secondary)] mb-6">Nutrition Consult Note Generator</h2>
                    <div id="nutrition-form-container" class="grid grid-cols-1 gap-4">
                        <!-- Dynamic fields -->
                    </div>
                    <div class="flex gap-4 mt-8 pt-4 border-t border-[var(--border-color)]">
                        <button id="nutritionGenerateBtn" class="btn-tech flex-1">Generate Note</button>
                        <button id="nutritionCopyBtn" class="btn-tech-outline flex-1">Copy to Clipboard</button>
                        <button id="nutritionSaveBtn" class="btn-tech-outline flex-1">Save as .txt</button>
                    </div>
                    <h2 class="text-xl font-semibold mt-6">Generated Note:</h2>
                    <textarea id="nutritionOutput" class="input-tech h-64 mt-4 font-mono text-xs" readonly></textarea>
                </div>
            </div>

            <!-- PAGE 7: STEROID -->
            <div id="steroid" class="content-page hidden fade-in max-w-3xl mx-auto">
                <div class="glass-panel p-8 space-y-6">
                    <h2 class="text-2xl font-bold flex items-center gap-3"><i class="ph ph-shield-check text-[var(--accent-primary)]"></i> Corticosteroid Equivalence Calculator</h2>
                    <p class="text-sm text-[var(--text-muted)]">Calculate equivalent anti-inflammatory doses for common corticosteroids.</p>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="text-xs text-[var(--text-muted)]">Convert From</label>
                            <select id="steroid_drug" class="input-tech">
                                <option value="hydrocortisone">Hydrocortisone</option>
                                <option value="cortisone">Cortisone</option>
                                <option value="prednisone">Prednisone</option>
                                <option value="prednisolone">Prednisolone</option>
                                <option value="methylprednisolone">Methylprednisolone</option>
                                <option value="triamcinolone">Triamcinolone</option>
                                <option value="dexamethasone">Dexamethasone</option>
                                <option value="betamethasone">Betamethasone</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-[var(--text-muted)]">Dose (mg)</label>
                            <input id="steroid_dose" type="number" class="input-tech" placeholder="20">
                        </div>
                        <button onclick="calculateSteroidEquivalence()" class="btn-tech">Calculate</button>
                    </div>
                    
                    <div id="steroidErrorMessage" class="hidden text-red-400 text-center"></div>
                    <div id="steroidResultsSection" class="hidden space-y-2">
                         <h2 class="text-xl font-bold text-white border-b border-[var(--border-color)] pb-2">Equivalent Anti-inflammatory Doses</h2>
                         <div id="steroidResultsList" class="space-y-2"></div>
                    </div>

                    <div class="mt-8">
                        <h4 class="text-lg font-bold text-[var(--text-muted)] mb-2">Corticosteroid Potency Reference</h4>
                        <table class="w-full text-xs text-left tech-table">
                             <thead class="text-[var(--accent-primary)]">
                                <tr><th>Corticosteroid</th><th>Equivalent Dose (mg)</th><th>Anti-inflammatory Potency</th><th>Mineralocorticoid Potency</th></tr>
                            </thead>
                            <tbody class="text-[var(--text-main)] opacity-80">
                                <tr><td>Hydrocortisone</td><td>20</td><td>1</td><td>1</td></tr>
                                <tr><td>Cortisone</td><td>25</td><td>0.8</td><td>0.8</td></tr>
                                <tr><td>Prednisone</td><td>5</td><td>4</td><td>0.6</td></tr>
                                <tr><td>Prednisolone</td><td>5</td><td>4</td><td>0.6</td></tr>
                                <tr><td>Methylprednisolone</td><td>4</td><td>5</td><td>0.5</td></tr>
                                <tr><td>Triamcinolone</td><td>4</td><td>5</td><td>0</td></tr>
                                <tr><td>Dexamethasone</td><td>0.75</td><td>25</td><td>0</td></tr>
                                <tr><td>Betamethasone</td><td>0.6</td><td>25</td><td>0</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div> <!-- End Content Area -->
    </main>

    <!-- Alert Container -->
    <div id="copy-alert"></div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- THEME SWITCHER LOGIC ---
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            document.documentElement.style.removeProperty('--accent-primary');
            document.documentElement.style.removeProperty('--accent-secondary');
            document.documentElement.style.removeProperty('--accent-primary-rgb');
            localStorage.setItem('medos-theme', themeName);
        }

        function setRandomTheme() {
            document.documentElement.setAttribute('data-theme', 'neon'); 
            const randomHue1 = Math.floor(Math.random() * 360);
            const randomHue2 = (randomHue1 + 180) % 360;
            const primaryColor = `hsl(${randomHue1}, 80%, 60%)`;
            const secondaryColor = `hsl(${randomHue2}, 80%, 60%)`;
            
            const hslToRgb = (h, s, l) => {
                s /= 100; l /= 100;
                const k = n => (n + h / 30) % 12;
                const a = s * Math.min(l, 1 - l);
                const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
                return [Math.round(f(0) * 255), Math.round(f(8) * 255), Math.round(f(4) * 255)];
            };
            const rgb = hslToRgb(randomHue1, 80, 60);

            document.documentElement.style.setProperty('--accent-primary', primaryColor);
            document.documentElement.style.setProperty('--accent-secondary', secondaryColor);
            document.documentElement.style.setProperty('--accent-primary-rgb', rgb.join(','));
        }

        // Initialize Theme
        const savedTheme = localStorage.getItem('medos-theme') || 'neon';
        setTheme(savedTheme);


        // --- NAVIGATION LOGIC ---
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.content-page');
        const pageTitle = document.getElementById('page-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const closeSidebar = document.getElementById('close-sidebar');

        function switchPage(targetId) {
            pages.forEach(p => p.classList.add('hidden'));
            const target = document.getElementById(targetId);
            if(target) target.classList.remove('hidden');

            navItems.forEach(n => n.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-target="${targetId}"]`);
            if(activeNav) {
                activeNav.classList.add('active');
                const text = activeNav.innerText.trim();
                pageTitle.textContent = text;
            }
            if(window.innerWidth < 768) sidebar.classList.add('-translate-x-full');
        }

        navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.target)));
        sidebarToggle.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
        closeSidebar.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));


        // --- GENERAL UTILITY ---
        const getEl = (id) => document.getElementById(id);
        const querySel = (sel) => document.querySelector(sel);
        const copyToClipboard = (txt) => {
            if (!txt) return;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(txt).then(() => showToast(txt)).catch(() => fallbackCopy(txt));
            } else {
                fallbackCopy(txt);
            }
        };
        const fallbackCopy = (txt) => {
            const ta = document.createElement('textarea');
            ta.value = txt;
            ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); showToast(txt); } catch (err) { console.error('Copy failed', err); }
            document.body.removeChild(ta);
        };
        const showToast = (txt) => {
            const alert = getEl('copy-alert');
            // Removed explicit text color classes to rely on CSS variable inheritance for theme compatibility
            alert.innerHTML = `<div class="flex items-center"><i class="ph ph-check-circle text-green-500 mr-3 text-2xl"></i><div>Copied to clipboard:<br><span class="font-semibold" style="color: var(--text-main)">${txt.replace(/\n/g, '<br>')}</span></div></div>`;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 4500);
        };

        // --- ICU ORDER LOGIC (RESTORED VENT TOGGLE) ---
        const ventMode = getEl('vent-mode');
        ventMode.addEventListener('change', toggleVentFields);
        
        function toggleVentFields() {
            const mode = ventMode.value;
            const display = (selector, condition) => {
                document.querySelector(selector).style.display = condition ? 'block' : 'none';
            };
            display('.vt-field', mode === 'VCV');
            display('.ip-field', mode === 'PCV' || mode === 'SIMV');
            display('.ps-field', mode === 'PSV' || mode === 'SIMV');
            display('.rr-field', mode !== 'PSV');
        }
        // Init call
        toggleVentFields();

        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                let text = "";
                
                // BD FEED
                if(id === 'bd_feed') {
                    const c = getEl('bd_feed-concentration').value;
                    const v = getEl('bd_feed-volume').value;
                    const f = getEl('bd_feed-frequency').value;
                    const fl = getEl('bd_feed-flush').value;
                    text = `BD (${c || 'N/A'}) ${v || 'N/A'} ml x ${f || 'N/A'} feeds\nน้ำตาม ${fl || 'N/A'} ml/F`;
                }
                // VENT (RESTORED EXACT LOGIC)
                else if(id === 'vent'){
                    const m = getEl('vent-mode').value;
                    const p = [];
                    // Exact replication of original buildText logic
                    if (m === 'VCV') p.push(`VT ${getEl('vent-VT').value}`);
                    if (m === 'PCV' || m === 'SIMV') p.push(`IP ${getEl('vent-IP').value}`);
                    if (m === 'PSV' || m === 'SIMV') p.push(`PS ${getEl('vent-PS').value}`);
                    if (m !== 'PSV') p.push(`RR ${getEl('vent-RR').value}`);
                    p.push(`Ti ${getEl('vent-Ti').value}`);
                    p.push(`FT ${getEl('vent-FT').value}`);
                    p.push(`PEEP ${getEl('vent-PEEP').value}`);
                    p.push(`FiO₂ ${getEl('vent-FiO2').value}`);
                    text = `On ventilator ${m} mode, ` + p.join(', ');
                }
                // MEDS
                else {
                    const titleMap = { midazolam: 'Midazolam', propofol: '1% Propofol', dexmed: 'Dexmedetomidine', fentanyl: 'Fentanyl', norepi: 'Levophed', epi: 'Epinephrine', dopamine: 'Dopamine', dobutamine: 'Dobutamine' };
                    const name = titleMap[id];
                    const concInput = getEl(id+'-concentration') || document.querySelector(`#${id}-concentration`);
                    const conc = concInput ? concInput.value : '';
                    const rate = getEl(id+'-rate').value;
                    
                    if(!rate) return;

                    text = `${name} (${conc})\nIV rate ${rate} mL/hr`;
                    if (id === 'fentanyl') text = `${name} (${conc}) IV rate ${rate} mL/hr`;

                    // CALCULATION: mcg/kg/min
                    const wtInput = getEl('vasopressors-weight');
                    const wt = parseFloat(wtInput ? wtInput.value : 0);
                    
                    if (['norepi', 'epi', 'dopamine', 'dobutamine'].includes(id) && wt > 0 && conc.includes(':')) {
                        const [mg, vol] = conc.split(':').map(Number);
                        if (vol > 0) {
                            const mgPerMl = mg / vol;
                            const dose = ((rate * mgPerMl * 1000) / 60 / wt).toFixed(2);
                            text = `${name} (${conc})\nIV ${rate} mL/hr [${dose} µg/kg/min]`;
                        }
                    }

                    if(id === 'norepi' || id === 'epi'){
                         const titrate = getEl(id+'-titrate').value;
                         text += `\nTitrate ครั้งละ ${titrate} ml/hr to maintain MAP >= 65 mmHg`;
                    }
                }

                if(text) copyToClipboard(text);
            });
        });

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parent = e.target.closest('.glass-panel');
                parent.querySelectorAll('.preset-btn').forEach(b => { b.classList.remove('bg-[var(--accent-primary)]', 'text-black'); b.classList.add('btn-tech-outline'); });
                e.target.classList.remove('btn-tech-outline'); e.target.classList.add('bg-[var(--accent-primary)]', 'text-black');
                const inputId = parent.querySelector('input[type="hidden"]').id;
                getEl(inputId).value = e.target.dataset.ratio;
            });
        });
        
        // --- ATB DATA (100% RESTORED FROM ORIGINAL SOURCE - FULL DATA) ---
        const antibioticData = {
            "Meropenem": { tiers: { "Usual Dose (1 g q8h)": { loading: "Not Required", doses: [{ min: 50.01, max: 130, dose: "1 g every 8 hours" }, { min: 25.01, max: 50, dose: "1 g every 12 hours" }, { min: 10, max: 25, dose: "500 mg every 12 hours" }], rrt: { "IHD": "500 mg every 24 hours, give after dialysis (AD) on HD days", "PD": "500 mg every 24 hours", "CRRT_II": "500 mg to 1 g every 8 hours", "CRRT_CI": "1 g infused over 12 hours, every 12 hours", "PIRRT_SLED": "1 g every 12 hours (Up to 2 g q8h if residual diuresis)" } }, "High Dose (2 g q8h)": { loading: "2 g (for Extended Infusion)", doses: [{ min: 50.01, max: 130, dose: "2 g every 8 hours" }, { min: 25.01, max: 50, dose: "2 g every 12 hours" }, { min: 10, max: 25, dose: "1 g every 12 hours" }, { min: 0, max: 9.99, dose: "1 g q24h or 500 mg q12h" }], rrt: { "IHD": "1 g every 24 hours or 500 mg every 12 hours, give after dialysis (AD) on HD days", "PD": "1 g q24h or 500 mg q12h", "CRRT_II": "500 mg to 1 g every 8 hours", "CRRT_CI": "1 g infused over 12 hours, every 12 hours", "PIRRT_SLED": "1 g every 12 hours (Up to 2 g q8h if residual diuresis)" } } } },
            "Piperacillin/Tazobactam": { tiers: { "High Dose (Antipseudomonal)": { loading: "4.5 g (for EI or CI)", doses: [{ min: 40.01, max: 130, dose: "4.5 g q6h (Extended Infusion preferred)" }, { min: 20, max: 40, dose: "3.375 g every 6 hours" }, { min: 0, max: 19.99, dose: "2.25 g every 6 hours" }], rrt: { "IHD": "4.5 g every 12 hours OR 2.25 g every 8 hours; plus a supplemental 2.25 g dose after dialysis on HD days", "PD": "4.5 g every 12 hours OR 2.25 g every 8 hours", "CRRT": "4.5 g every 8 hours OR 2.25 g every 6 hours OR 9 g/24h continuous infusion", "PIRRT_SLED": "3.375 g every 8 hours" } } } },
            "Levofloxacin": { tiers: { "High Dose (750 mg q24h)": { loading: "750 mg x 1", doses: [{ min: 50, max: Infinity, dose: "750 mg every 24 hours" }, { min: 20, max: 49.99, dose: "750 mg every 48 hours" }, { min: 0, max: 19.99, dose: "500 mg every 48 hours" }], rrt: { "IHD": "500 mg every 48 hours", "PD": "500 mg every 48 hours", "CRRT": "500 mg every 48 hours" } } } },
            "Ceftazidime": { tiers: { "Usual Dose (1 g q8h)": { loading: "Not Required", doses: [{ min: 50.01, max: Infinity, dose: "1 g every 8 hours" }, { min: 31, max: 50, dose: "1 g every 12 hours" }, { min: 16, max: 30.99, dose: "1 g every 24 hours" }, { min: 0, max: 15.99, dose: "500 mg every 24 hours" }], rrt: { "IHD": "500 mg - 1 g q24h post-HD OR 1 g 3x/week post-HD", "PD": "1 g every 24 hours", "CRRT_II": "2 g q8-12h", "CRRT_CI": "3 g/24h continuous infusion", "PIRRT_SLED": "2 g every 12 hours" } }, "High Dose (2 g q8h)": { loading: "2 g (for Extended Infusion)", doses: [{ min: 50.01, max: Infinity, dose: "2 g every 8 hours" }, { min: 31, max: 50, dose: "2 g every 12 hours" }, { min: 16, max: 30.99, dose: "2 g every 24 hours" }, { min: 0, max: 15.99, dose: "1 g every 24 hours" }], rrt: { "IHD": "500 mg - 1 g q24h post-HD OR 1 g 3x/week post-HD", "PD": "1 g every 24 hours", "CRRT_II": "2 g q8-12h", "CRRT_CI": "3 g/24h continuous infusion", "PIRRT_SLED": "2 g every 12 hours" } } } },
            "Imipenem/Cilastatin": { tiers: { "Usual Dose (500 mg q6h)": { loading: "Not Required", doses: [{ min: 60, max: 130, dose: "500 mg every 6 hours" }, { min: 30, max: 59.99, dose: "250 mg every 6 hours OR 500 mg every 8 hours" }, { min: 15, max: 29.99, dose: "250 mg every 8 hours OR 500 mg every 12 hours" }, { min: 0, max: 14.99, dose: "Do not administer unless HD is instituted within 48 hours." }], rrt: { "IHD": "250 to 500 mg every 12 hours (give after HD)", "PD": "250 to 500 mg every 12 hours", "CRRT": "1 g loading dose, then 250 mg q6h or 500 mg q6-8h", "PIRRT_SLED": "500 mg to 1 g loading dose, then 250 mg q6h or 500 mg q8h (give after PIRRT). Note: Higher doses increase neurotoxicity risk; consider alternatives." } }, "Usual Dose (1 g q8h)": { loading: "Not Required", doses: [{ min: 60, max: 130, dose: "1 g every 8 hours" }, { min: 30, max: 59.99, dose: "500 mg every 8 hours" }, { min: 15, max: 29.99, dose: "250 mg every 8 hours OR 500 mg every 12 hours" }, { min: 0, max: 14.99, dose: "Do not administer unless HD is instituted within 48 hours." }], rrt: { "IHD": "250 to 500 mg every 12 hours (give after HD)", "PD": "250 to 500 mg every 12 hours", "CRRT": "1 g loading dose, then 250 mg q6h or 500 mg q6-8h", "PIRRT_SLED": "500 mg to 1 g loading dose, then 250 mg q6h or 500 mg q8h (give after PIRRT). Note: Higher doses increase neurotoxicity risk; consider alternatives." } }, "Usual Dose (1 g q6h)": { loading: "Not Required", doses: [{ min: 60, max: 130, dose: "1 g every 6 hours" }, { min: 30, max: 59.99, dose: "500 mg every 6 hours" }, { min: 15, max: 29.99, dose: "250 mg every 6 hours" }, { min: 0, max: 14.99, dose: "Do not administer unless HD is instituted within 48 hours." }], rrt: { "IHD": "250 to 500 mg every 12 hours (give after HD)", "PD": "250 to 500 mg every 12 hours", "CRRT": "1 g loading dose, then 250 mg q6h or 500 mg q6-8h", "PIRRT_SLED": "500 mg to 1 g loading dose, then 250 mg q6h or 500 mg q8h (give after PIRRT). Note: Higher doses increase neurotoxicity risk; consider alternatives." } } } },
            "IV Fosfomycin": { tiers: { "All Systemic Infections": { loading: "6 - 8 g IV x 1 dose", pathogens: { "E. coli": [{ min: 80, max: 100, dose: "2 g q12h" }, { min: 40, max: 50, dose: "1 g q12h" }, { min: 20, max: 30, dose: "500 mg q12h" }], "K. pneumo": [{ min: 80, max: 100, dose: "4 g q12h" }, { min: 40, max: 50, dose: "2 g q12h" }, { min: 20, max: 30, dose: "1 g q12h" }], "Pseudo/Acine": [{ min: 80, max: 100, dose: "4 g q8h" }, { min: 40, max: 50, dose: "2 g q8h" }, { min: 20, max: 30, dose: "1 g q8h" }] } } } },
            "Colistin": { tiers: { "All Indications": { loading: "300 mg IV (Universal)", doses: [{ min: 80.01, max: Infinity, dose: "150 mg every 8 - 12 hours" }, { min: 40.01, max: 80, dose: "150 mg every 12 hours" }, { min: 20.01, max: 40, dose: "100 mg every 12 hours" }, { min: 0, max: 20, dose: "150 mg every 24 hours" }], rrt: { "IHD": "Non-dialysis day: 150 mg q24h; Dialysis day: 200 mg post-dialysis", "CRRT": "150 mg every 8 hours", "PD": "100 mg every 24 hours" } } } }
        };

        const fullAtbTableData = [
            { antibiotic: "Meropenem", indication: "Usual Dose (1 g q8h)", loading: "Not Required", crcl: ">50 to <130", dose: "1 g every 8 hours" }, { crcl: ">25 to ≤50", dose: "1 g every 12 hours" }, { crcl: "10 to ≤25", dose: "500 mg every 12 hours" }, { crcl: "IHD", dose: "500 mg every 24 hours, give after dialysis (AD) on HD days" },
            { antibiotic: "Meropenem", indication: "High Dose (2 g q8h, CNS, CF, high MIC)", loading: "2 g (for Extended Infusion)", crcl: ">50 to <130", dose: "2 g every 8 hours" }, { crcl: ">25 to ≤50", dose: "2 g every 12 hours" }, { crcl: "10 to ≤25", dose: "1 g every 12 hours" }, { crcl: "IHD", dose: "1 g every 24 hours or 500 mg every 12 hours, give after dialysis (AD) on HD days" },
            { antibiotic: "Meropenem", indication: "RRT Dosing (Specific Regimens)", loading: "1 g", crcl: "CRRT (Intermittent Infusion)", dose: "500 mg to 1 g every 8 hours" }, { crcl: "CRRT (Continuous Infusion)", dose: "1 g infused over 12 hours, every 12 hours" }, { crcl: "PIRRT / SLED", dose: "1 g every 12 hours (Up to 2 g q8h if residual diuresis)" },
            { antibiotic: "Piperacillin/Tazobactam", indication: "High Dose (Antipseudomonal)", loading: "4.5 g (for EI or CI)", crcl: ">40 to <130", dose: "4.5 g q6h (Extended Infusion preferred)" }, { crcl: "20 - 40", dose: "3.375 g every 6 hours" }, { crcl: "<20", dose: "2.25 g every 6 hours" },
            { antibiotic: "Piperacillin/Tazobactam", indication: "Renal Replacement Therapy", loading: "4.5 g (for EI or CI)", crcl: "Hemodialysis (IHD) / PD", dose: "4.5 g every 12 hours OR 2.25 g every 8 hours; plus a supplemental 2.25 g dose after dialysis on HD days" }, { crcl: "CRRT", dose: "4.5 g every 8 hours OR 2.25 g every 6 hours OR 9 g/24h continuous infusion" }, { crcl: "PIRRT / SLED", dose: "3.375 g every 8 hours" },
            { antibiotic: "Levofloxacin", indication: "High Dose (750 mg q24h, HAP/VAP)", loading: "750 mg x 1", crcl: ">50", dose: "750 mg every 24 hours" }, { crcl: "20-49", dose: "750 mg every 48 hours" }, { crcl: "<20", dose: "500 mg every 48 hours" }, { crcl: "IHD / PD / CRRT", dose: "500 mg every 48 hours" },
            { antibiotic: "Ceftazidime", indication: "Usual Dose (1 g q8h)", loading: "Not Required", crcl: ">50", dose: "1 g every 8 hours" }, { crcl: "31 - 50", dose: "1 g every 12 hours" }, { crcl: "16 - 30", dose: "1 g every 24 hours" }, { crcl: "≤15", dose: "500 mg every 24 hours" },
            { antibiotic: "Ceftazidime", indication: "High Dose (2 g q8h, Antipseudomonal)", loading: "2 g (for Extended Infusion)", crcl: ">50", dose: "2 g every 8 hours" }, { crcl: "31 - 50", dose: "2 g every 12 hours" }, { crcl: "16 - 30", dose: "2 g every 24 hours" }, { crcl: "≤15", dose: "1 g every 24 hours" },
            { antibiotic: "Ceftazidime", indication: "RRT Dosing (Specific Regimens)", loading: "2 g (for CRRT Continuous Infusion)", crcl: "Hemodialysis (IHD)", dose: "500 mg - 1 g q24h post-HD OR 1 g 3x/week post-HD" }, { crcl: "Peritoneal Dialysis (PD)", dose: "1 g every 24 hours" }, { crcl: "CRRT", dose: "2 g q8-12h OR 3 g/24h continuous infusion" }, { crcl: "PIRRT / SLED", dose: "2 g every 12 hours" },
            { antibiotic: "Imipenem/Cilastatin", indication: "Usual Dose (500 mg q6h)", loading: "Not Required", crcl: "≥60 to <130", dose: "500 mg every 6 hours" }, { crcl: "≥30 to <60", dose: "250 mg every 6 hours OR 500 mg every 8 hours" }, { crcl: "≥15 to <30", dose: "250 mg every 8 hours OR 500 mg every 12 hours" }, { crcl: "<15", dose: "Do not administer unless HD is instituted within 48 hours." },
            { antibiotic: "Imipenem/Cilastatin", indication: "Usual Dose (1 g q8h)", loading: "Not Required", crcl: "≥60 to <130", dose: "1 g every 8 hours" }, { crcl: "≥30 to <60", dose: "500 mg every 8 hours" }, { crcl: "≥15 to <30", dose: "250 mg every 8 hours OR 500 mg every 12 hours" }, { crcl: "<15", dose: "Do not administer unless HD is instituted within 48 hours." },
            { antibiotic: "Imipenem/Cilastatin", indication: "Usual Dose (1 g q6h)", loading: "Not Required", crcl: "≥60 to <130", dose: "1 g every 6 hours" }, { crcl: "≥30 to <60", dose: "500 mg every 6 hours" }, { crcl: "≥15 to <30", dose: "250 mg every 6 hours" }, { crcl: "<15", dose: "Do not administer unless HD is instituted within 48 hours." },
            { antibiotic: "Imipenem/Cilastatin", indication: "Renal Replacement Therapy", loading: "Note RRT Loading Doses", crcl: "IHD", dose: "250 to 500 mg every 12 hours (give after HD)" }, { crcl: "PD", dose: "250 to 500 mg every 12 hours" }, { crcl: "CRRT", dose: "1 g loading dose, then 250 mg q6h or 500 mg q6-8h" }, { crcl: "PIRRT / SLED", dose: "500 mg to 1 g loading dose, then 250 mg q6h or 500 mg q8h (give after PIRRT)" },
            { antibiotic: "IV Fosfomycin", indication: "All Systemic Infections", loading: "6 - 8 g x 1 dose", crcl: "80 - 100", dose: "• E. coli: 2 g q12h • K. pneumo: 4 g q12h • Pseudo/Acine: 4 g q8h" }, { crcl: "40 - 50", dose: "• E. coli: 1 g q12h • K. pneumo: 2 g q12h • Pseudo/Acine: 2 g q8h" }, { crcl: "20 - 30", dose: "• E. coli: 500 mg q12h • K. pneumo: 1 g q12h • Pseudo/Acine: 1 g q8h" },
            { antibiotic: "Colistin", indication: "All Indications", loading: "300 mg (Universal)", crcl: ">80", dose: "150 mg every 8 - 12 hours" }, { crcl: ">40 to 80", dose: "150 mg every 12 hours" }, { crcl: ">20 to 40", dose: "100 mg every 12 hours" }, { crcl: "≤20", dose: "150 mg every 24 hours" },
            { antibiotic: "Colistin", indication: "All Indications (RRT)", loading: "300 mg (Universal)", crcl: "IHD", dose: "Non-dialysis day: 150 mg q24h; Dialysis day: 200 mg post-dialysis" }, { crcl: "CRRT", dose: "150 mg every 8 hours" }, { crcl: "PD", dose: "100 mg every 24 hours" },
        ];

        function populateAtbTable() {
            const tbody = getEl('atb-reference-tbody');
            let html = '';
            fullAtbTableData.forEach(row => {
                html += `<tr>
                    <td class="font-bold ${row.antibiotic ? 'text-[var(--accent-primary)]' : ''}">${row.antibiotic || ''}</td>
                    <td>${row.indication || ''}</td>
                    <td>${row.loading || ''}</td>
                    <td>${row.crcl || ''}</td>
                    <td>${row.dose || ''}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }
        populateAtbTable();

        getEl('atb-select').addEventListener('change', (e) => {
             const atb = antibioticData[e.target.value];
             const tierSelect = getEl('atb-dose-tier');
             tierSelect.innerHTML = '';
             getEl('pathogen-container').classList.add('hidden');
             if(atb) {
                 Object.keys(atb.tiers).forEach(t => tierSelect.add(new Option(t,t)));
                 if(e.target.value === 'IV Fosfomycin') {
                     getEl('pathogen-container').classList.remove('hidden');
                     const pathSelect = getEl('atb-pathogen');
                     pathSelect.innerHTML = '';
                     Object.keys(atb.tiers["All Systemic Infections"].pathogens).forEach(p => pathSelect.add(new Option(p,p)));
                 }
             }
        });

        getEl('calculate-crcl-btn').addEventListener('click', () => {
            const age = parseFloat(getEl('crcl-age').value);
            const wt = parseFloat(getEl('crcl-weight').value);
            const cr = parseFloat(getEl('crcl-creatinine').value);
            const sex = getEl('crcl-sex').value;
            
            if(age && wt && cr) {
                let crcl = ((140 - age) * wt) / (72 * cr);
                if(sex === 'female') crcl *= 0.85;
                const val = crcl.toFixed(1);
                getEl('crcl-result').textContent = `${val} mL/min`;
                getEl('atb-crcl').value = val;
            }
        });

        getEl('calculate-atb-dose-btn').addEventListener('click', () => {
            const atbName = getEl('atb-select').value;
            const tierName = getEl('atb-dose-tier').value;
            const crcl = parseFloat(getEl('atb-crcl').value);
            let rrt = getEl('atb-rrt').value;
            const resultEl = getEl('atb-dose-result');
            
            if (!atbName || !tierName) { resultEl.textContent = "Select Antibiotic"; return; }
            
            const atb = antibioticData[atbName];
            const tier = atb.tiers[tierName];
            let dose = "Not found";

            if (rrt !== 'none') {
                if (tier.rrt && tier.rrt[rrt]) { dose = tier.rrt[rrt]; } 
                else if (tier.rrt && tier.rrt.CRRT && rrt.startsWith('CRRT')) { dose = tier.rrt.CRRT; }
                else if (tier.rrt && tier.rrt.CRRT_II && rrt === 'CRRT_II') { dose = tier.rrt.CRRT_II; }
                else if (tier.rrt && tier.rrt.CRRT_CI && rrt === 'CRRT_CI') { dose = tier.rrt.CRRT_CI; }
                else if (tier.rrt && tier.rrt.PIRRT_SLED && rrt === 'PIRRT_SLED') { dose = tier.rrt.PIRRT_SLED; }
            } else if (!isNaN(crcl)) {
                if (atbName === 'IV Fosfomycin') {
                    const path = getEl('atb-pathogen').value;
                    const doses = tier.pathogens[path];
                    for (const d of doses) { if (crcl >= d.min && crcl <= d.max) { dose = d.dose; break; } }
                } else if (tier.doses) {
                    const sorted = tier.doses.sort((a, b) => b.min - a.min);
                    for (const d of sorted) { if (crcl >= d.min) { dose = d.dose; break; } }
                }
            } else {
                dose = "Calculate CrCl first";
            }
            
            resultEl.innerHTML = `<div class="font-bold text-[var(--accent-primary)]">${dose}</div>`;
        });
        getEl('show-loading-dose-btn').addEventListener('click', () => {
             const atbName = getEl('atb-select').value;
             const tierName = getEl('atb-dose-tier').value;
             if(atbName && tierName) {
                 getEl('atb-dose-result').innerHTML = `<div class="font-bold">Loading: ${antibioticData[atbName].tiers[tierName].loading}</div>`;
             }
        });


        // --- ABG LOGIC (FULL MATH & DETAILED HTML) ---
        function analyzeABG() {
            const ph = parseFloat(getEl('ph').value);
            const paco2 = parseFloat(getEl('paco2').value);
            const hco3 = parseFloat(getEl('hco3').value);
            const na = parseFloat(getEl('na').value);
            const cl = parseFloat(getEl('cl').value);
            const alb = parseFloat(getEl('albumin').value);
            
            const resSection = getEl('abgResultsSection');
            const err = getEl('abgErrorMessage');

            if(isNaN(ph) || isNaN(paco2) || isNaN(hco3)) {
                err.classList.remove('hidden'); getEl('abgErrorMessageText').innerText = "Missing pH, PaCO2 or HCO3"; return;
            }
            err.classList.add('hidden');
            resSection.classList.remove('hidden');

            let disorder = "Normal ABG";
            let isMetabolic = false;
            let isRespiratory = false;

            if(ph < 7.35) {
                if(hco3 < 22) { disorder = "Metabolic Acidosis"; isMetabolic = true; }
                else if(paco2 > 45) { disorder = "Respiratory Acidosis"; isRespiratory = true; }
                else disorder = "Mixed Acidosis";
            } else if(ph > 7.45) {
                 if(hco3 > 26) { disorder = "Metabolic Alkalosis"; isMetabolic = true; }
                 else if(paco2 < 35) { disorder = "Respiratory Alkalosis"; isRespiratory = true; }
                 else disorder = "Mixed Alkalosis";
            } else {
                if(paco2 > 45 && hco3 > 26) disorder = "Compensated Respiratory Acidosis";
                else if(paco2 < 35 && hco3 < 22) disorder = "Compensated Respiratory Alkalosis";
                else if(hco3 < 22 && paco2 < 35) disorder = "Compensated Metabolic Acidosis";
                else if(hco3 > 26 && paco2 > 45) disorder = "Compensated Metabolic Alkalosis";
                else disorder = "Normal ABG or Mixed Disorder";
            }

            getEl('primaryDisorderResult').innerHTML = `<div class="result-card bg-slate-700/50 border-l-cyan-500"><h4>Primary Disorder</h4><p class="text-xl font-bold text-white mt-1">${disorder}</p></div>`;
            getEl('anionGapResult').innerHTML = '';
            getEl('compensationResult').innerHTML = '';
            getEl('respiratoryTiming').classList.add('hidden');
            let summary = `${disorder}.`;

            // --- METABOLIC ACIDOSIS LOGIC ---
            if(disorder.includes("Metabolic Acidosis")) {
                 const expectedPaco2 = (1.5 * hco3) + 8;
                 const lower = expectedPaco2 - 2;
                 const upper = expectedPaco2 + 2;
                 
                 let compText = `appropriate respiratory compensation`;
                 if(paco2 > upper) compText = `a concurrent primary respiratory acidosis`;
                 else if(paco2 < lower) compText = `a concurrent primary respiratory alkalosis`;
                 
                 getEl('compensationResult').innerHTML = `
                    <div class="result-card">
                        <h4>Compensation Analysis</h4><h4 class="mt-2">Winter's Formula (Expected PaCO₂)</h4>
                        <p class="mt-2">Calculates the expected respiratory compensation for the metabolic acidosis.</p>
                        <p class="mt-2"><strong>Expected PaCO₂ Range:</strong> <span class="text-white font-bold">${lower.toFixed(2)} - ${upper.toFixed(2)} mmHg</span></p>
                        <p><strong>Patient's PaCO₂:</strong> <span class="text-white font-bold">${paco2} mmHg</span></p>
                        <p><strong>Interpretation:</strong> This indicates ${compText}.</p>
                        <div class="formula"><p><strong>Expected PaCO₂ = (1.5 * [HCO₃⁻]) + 8 ± 2</strong></p><p>= (1.5 * ${hco3}) + 8 ± 2 = ${expectedPaco2.toFixed(2)} ± 2</p></div>
                    </div>`;
                 getEl('compensationResult').classList.remove('hidden');
                 summary += ` with ${compText}.`;

                 if(!isNaN(na) && !isNaN(cl) && !isNaN(alb)) {
                     const ag = na - (cl + hco3);
                     const corrAg = ag + 2.5 * (4 - alb);
                     const type = corrAg > 12 ? "High Anion Gap" : "Non-Anion Gap";
                     
                     let deltaHtml = '';
                     if(corrAg > 12) {
                         const deltaRatio = (corrAg - 12) / (24 - hco3);
                         let deltaInterp = "a pure High-Anion Gap Metabolic Acidosis.";
                         if(deltaRatio < 1) deltaInterp = "a concurrent Non-Anion Gap Metabolic Acidosis.";
                         else if(deltaRatio > 2) deltaInterp = "a concurrent metabolic alkalosis.";
                         
                         deltaHtml = `
                            <h4 class="mt-4">Delta-Delta Gap (ΔΔ Gap)</h4><p class="mt-2">Used in HAGMA to detect underlying mixed metabolic disorders.</p>
                            <p class="mt-2"><strong>Ratio (ΔAG/ΔHCO₃⁻):</strong> <span class="text-white font-bold">${deltaRatio.toFixed(2)}</span></p>
                            <p><strong>Interpretation:</strong> Suggests ${deltaInterp}</p>
                            <div class="formula"><p><strong>Ratio = (AG - 12) / (24 - [HCO₃⁻])</strong></p><p>= (${corrAg.toFixed(2)} - 12) / (24 - ${hco3}) = ${deltaRatio.toFixed(2)}</p></div>`;
                         summary += ` ${type} Metabolic Acidosis (HAGMA/NAGMA). Suggests ${deltaInterp}`;
                     } else {
                         summary += ` ${type} Metabolic Acidosis (HAGMA/NAGMA).`;
                     }

                     getEl('anionGapResult').innerHTML = `
                        <div class="result-card">
                            <h4>Anion Gap (AG) Analysis</h4><p class="mt-2">The Anion Gap helps differentiate the cause of a metabolic acidosis.</p>
                            <div class="mt-2 space-y-2"><p><strong>Calculated AG:</strong> <span class="text-white font-bold">${ag.toFixed(2)}</span></p><p><strong>Albumin-Corrected AG:</strong> <span class="text-white font-bold">${corrAg.toFixed(2)}</span></p><p><strong>Interpretation:</strong> <span class="text-white font-bold">${type} Metabolic Acidosis (HAGMA/NAGMA)</span></p></div>
                            <div class="formula"><p><strong>Corrected AG = [Na⁺] - ([Cl⁻] + [HCO₃⁻]) + 2.5 * (4.0 - Albumin)</strong></p><p>= ${na} - (${cl} + ${hco3}) + 2.5 * (4.0 - ${alb}) = ${corrAg.toFixed(2)}</p></div>
                            ${deltaHtml}
                        </div>`;
                     getEl('anionGapResult').classList.remove('hidden');
                 }
            } 
            // --- RESPIRATORY LOGIC ---
            else if (isRespiratory) {
                getEl('respiratoryTiming').classList.remove('hidden');
                const timing = document.querySelector('input[name="timing"]:checked')?.value;
                
                if(timing) {
                    const dPaCO2 = Math.abs(paco2 - 40)/10;
                    let expHCO3 = 0;
                    let formulaStr = "";
                    
                    if(disorder.includes("Acidosis")) {
                        if(timing === 'acute') {
                            expHCO3 = 24 + (1 * dPaCO2);
                            formulaStr = `Expected [HCO₃⁻] = 24 + 1 * ((${paco2} - 40) / 10)`;
                        } else {
                            expHCO3 = 24 + (4 * dPaCO2);
                            formulaStr = `Expected [HCO₃⁻] = 24 + 4 * ((${paco2} - 40) / 10)`;
                        }
                    } else { // Alkalosis
                        if(timing === 'acute') {
                            expHCO3 = 24 - (2 * dPaCO2);
                            formulaStr = `Expected [HCO₃⁻] = 24 - 2 * ((40 - ${paco2}) / 10)`;
                        } else {
                            expHCO3 = 24 - (5 * dPaCO2);
                            formulaStr = `Expected [HCO₃⁻] = 24 - 5 * ((40 - ${paco2}) / 10)`;
                        }
                    }
                    
                    let interp = "appropriate metabolic compensation";
                    if(hco3 > expHCO3 + 2) interp = "a concurrent metabolic alkalosis";
                    else if(hco3 < expHCO3 - 2) interp = "a concurrent metabolic acidosis";

                    getEl('compensationResult').innerHTML = `
                        <div class="result-card">
                            <h4>Compensation Analysis (${timing.charAt(0).toUpperCase() + timing.slice(1)})</h4>
                            <p class="mt-2">Calculates the expected metabolic compensation for the respiratory disorder.</p>
                            <p class="mt-2"><strong>Expected HCO₃⁻:</strong> <span class="text-white font-bold">~${expHCO3.toFixed(2)} mEq/L</span></p>
                            <p><strong>Patient's HCO₃⁻:</strong> <span class="text-white font-bold">${hco3} mEq/L</span></p>
                            <p><strong>Interpretation:</strong> Suggests ${interp}.</p>
                            <div class="formula"><p><strong>${formulaStr}</strong> = ${expHCO3.toFixed(2)}</p></div>
                        </div>`;
                    getEl('compensationResult').classList.remove('hidden');
                    summary += ` ${timing.charAt(0).toUpperCase()+timing.slice(1)} ${disorder} with ${interp}.`;
                }
            }
            
            getEl('summaryText').innerText = summary;
        }

        // --- CALCIUM LOGIC ---
        function calculateCorrectedCalcium() {
            const ca = parseFloat(getEl('totalCalcium').value);
            const alb = parseFloat(getEl('albumin_ca').value);
            if(ca && alb) {
                const corr = ca + 0.8 * (4 - alb);
                getEl('correctedCalciumResult').innerHTML = `Corrected Calcium: <span class="font-bold text-white">${corr.toFixed(2)} mg/dL</span>`;
                getEl('correctedCalciumResult').classList.remove('hidden');
            }
        }

        const infusionInputs = { rate: 'infusion_rate', weight: 'infusion_weight', caVol: 'infusion_caVolume', ivVol: 'infusion_ivVolume', drip: 'infusion_dripRate', tot: 'infusion_totalVolume' };
        const CaContent = 9.3; 

        function calculateInfusion(target) {
            const vals = {};
            for(let k in infusionInputs) vals[k] = parseFloat(getEl(infusionInputs[k]).value);
            
            if(isNaN(vals.tot) && !isNaN(vals.caVol) && !isNaN(vals.ivVol)) {
                vals.tot = vals.caVol + vals.ivVol;
                getEl('infusion_totalVolume').value = vals.tot;
            }

            let res = 0;
            if(target === 'rate' && vals.caVol && vals.tot && vals.drip && vals.weight) {
                res = ((vals.caVol * CaContent) / vals.tot * vals.drip) / vals.weight;
            } else if (target === 'dripRate' && vals.rate && vals.weight && vals.caVol && vals.tot) {
                res = (vals.rate * vals.weight * vals.tot) / (vals.caVol * CaContent);
            } else if (target === 'caVolume' && vals.rate && vals.weight && vals.tot && vals.drip) {
                res = (vals.rate * vals.weight * vals.tot) / (CaContent * vals.drip);
            } else if (target === 'weight' && vals.rate && vals.caVol && vals.tot && vals.drip) {
                res = ((vals.caVol * CaContent) / vals.tot * vals.drip) / vals.rate;
            }

            if(res) getEl(infusionInputs[target === 'rate' ? 'rate' : (target === 'weight' ? 'weight' : (target === 'caVolume' ? 'caVolume' : 'drip'))]).value = res.toFixed(2);
        }

        function toggleDurationSection() { getEl('durationSection').classList.toggle('hidden'); }
        function calculateDuration(type){
            const vol = parseFloat(getEl('duration_totalVolume').value);
            const rate = parseFloat(getEl('duration_dripRate').value);
            if(vol && rate) getEl('duration_time').value = (vol/rate).toFixed(1);
        }


        // --- CALSULIN LOGIC ---
        let calculatedRegimen = null;
        let calculatedTDD = null;

        function showCalsulinTab(step) {
            document.querySelectorAll('#calsulin .tab-content').forEach(el => el.classList.add('hidden'));
            getEl('calsulin-'+step).classList.remove('hidden');
            ['step1','step2','step3'].forEach(s => {
                const btn = getEl('calsulin-'+s+'-btn');
                if(s === step) { btn.classList.remove('btn-tech-outline'); btn.classList.add('btn-tech'); }
                else { btn.classList.add('btn-tech-outline'); btn.classList.remove('btn-tech'); }
            });
        }

        function roundDose(dose) {
            if (dose <= 0) return 0;
            const rounded = Math.round(dose);
            if (rounded < 4) return 4;
            return rounded % 2 === 0 ? rounded : rounded + 1;
        }

        const step1Inputs = document.querySelectorAll('#calsulin-step1 input');
        step1Inputs.forEach(input => {
            input.addEventListener('change', () => {
                const method = document.querySelector('input[name="tddMethod"]:checked').value;
                let tdd = 0;
                const reg = document.querySelector('input[name="feedingFrequency"]:checked')?.value;
                
                if(method === 'calculate') {
                    const wt = parseFloat(getEl('bodyWeight').value);
                    const unit = parseFloat(document.querySelector('input[name="tddUnit"]:checked').value);
                    if(wt && unit) tdd = wt * unit;
                } else {
                    tdd = parseFloat(getEl('manualTdd').value);
                }

                if(tdd > 0 && reg) {
                    calculatedTDD = tdd;
                    getEl('tddResult').innerText = tdd.toFixed(0) + ' U';
                    
                    let basal=0, bolus=0, schedHTML='';
                    let log = [];
                    
                    if(reg === '3meals') {
                        const rawBolus = tdd * 0.7; const rawBasal = tdd * 0.3;
                        const riPerMeal = rawBolus / 3;
                        const riDose = roundDose(riPerMeal);
                        const nphDose = roundDose(rawBasal);
                        basal = nphDose; bolus = riDose * 3;
                        
                        log.push(`2. Split (30/70): Basal=${rawBasal.toFixed(2)}U, Bolus=${rawBolus.toFixed(2)}U`);
                        log.push(`3. Dosing: RI=${riPerMeal.toFixed(2)}U/meal, NPH=${rawBasal.toFixed(2)}U`);
                        log.push(`4. Rounded: RI=${riDose}U, NPH=${nphDose}U`);
                        
                        schedHTML = `<tr><td>06:00</td><td>RI (Regular)</td><td>${riDose}</td></tr>
                                     <tr><td>12:00</td><td>RI (Regular)</td><td>${riDose}</td></tr>
                                     <tr><td>18:00</td><td>RI (Regular)</td><td>${riDose}</td></tr>
                                     <tr><td>23:00</td><td>NPH</td><td>${nphDose}</td></tr>`;
                        getEl('basalDose').value = nphDose; getEl('bolusDose').value = riDose;
                        getEl('regimenType').value = 'basalBolus';
                    } else if(reg === '4meals') {
                        const rawBolus = tdd * 0.5; const rawBasal = tdd * 0.5;
                        const riPerMeal = rawBolus / 4; const nphPerDose = rawBasal / 2;
                        const riDose = roundDose(riPerMeal); const nphDose = roundDose(nphPerDose);
                        basal = nphDose * 2; bolus = riDose * 4;
                        
                        log.push(`2. Split (50/50): Basal=${rawBasal.toFixed(2)}U, Bolus=${rawBolus.toFixed(2)}U`);
                        log.push(`3. Dosing: RI=${riPerMeal.toFixed(2)}U/feed, NPH=${nphPerDose.toFixed(2)}U/dose`);
                        log.push(`4. Rounded: RI=${riDose}U, NPH=${nphDose}U`);

                        schedHTML = `<tr><td>06:00</td><td>RI + NPH</td><td>${riDose} + ${nphDose}</td></tr>
                                     <tr><td>12:00</td><td>RI (Regular)</td><td>${riDose}</td></tr>
                                     <tr><td>18:00</td><td>RI + NPH</td><td>${riDose} + ${nphDose}</td></tr>
                                     <tr><td>23:00</td><td>RI (Regular)</td><td>${riDose}</td></tr>`;
                        getEl('basalDose').value = nphDose; getEl('bolusDose').value = riDose;
                        getEl('regimenType').value = 'basalBolus';
                    } else { // Premixed
                        const rawMorning = (tdd * 2) / 3; const rawEvening = tdd / 3;
                        const morningDose = roundDose(rawMorning); const eveningDose = roundDose(rawEvening);
                        basal = Math.round((morningDose+eveningDose)*0.7); bolus = Math.round((morningDose+eveningDose)*0.3); // Approximate display for step 1 UI
                        
                        log.push(`2. Split (2/3, 1/3): Morning=${rawMorning.toFixed(2)}U, Evening=${rawEvening.toFixed(2)}U`);
                        log.push(`3. Rounded: Morning=${morningDose}U, Evening=${eveningDose}U`);

                        schedHTML = `<tr><td>06:00</td><td>Premixed (70/30)</td><td>${morningDose}</td></tr>
                                     <tr><td>18:00</td><td>Premixed (70/30)</td><td>${eveningDose}</td></tr>`;
                        getEl('premixedMorningDose').value = morningDose; getEl('premixedEveningDose').value = eveningDose;
                        getEl('regimenType').value = 'premixed';
                    }

                    getEl('basalResult').innerText = basal + ' U';
                    getEl('bolusResult').innerText = bolus + ' U';
                    getEl('noSelectionMessage').classList.add('hidden');
                    getEl('calsulin-resultsContent').classList.remove('hidden');
                    getEl('scheduleBody').innerHTML = schedHTML;
                    getEl('calculationText').innerText = log.join('\n');
                }
            });
        });

        document.querySelectorAll('input[name="tddMethod"]').forEach(r => {
            r.addEventListener('change', (e) => {
                if(e.target.value === 'calculate') { getEl('calculationInputs').classList.remove('hidden'); getEl('manualTddInput').classList.add('hidden'); }
                else { getEl('calculationInputs').classList.add('hidden'); getEl('manualTddInput').classList.remove('hidden'); }
            });
        });
        
        // Update Inputs on Step 2 Change
        getEl('regimenType').addEventListener('change', () => {
             const isBB = getEl('regimenType').value === 'basalBolus';
             getEl('basalBolusInputs').classList.toggle('hidden', !isBB);
             getEl('premixedInputs').classList.toggle('hidden', isBB);
        });

        function proceedToStep2() { showCalsulinTab('step2'); getEl('regimenType').dispatchEvent(new Event('change')); }

        function generateOrder() {
            const type = getEl('regimenType').value;
            let text = "";
            if(type === 'basalBolus') {
                const feeding = document.querySelector('input[name="feedingSchedule"]:checked').value;
                const basal = getEl('basalDose').value;
                const bolus = getEl('bolusDose').value;
                const bType = getEl('basalType').value;
                const boType = getEl('bolusType').value;
                const isFour = feeding === '4';
                const times = isFour ? '6, 12, 18, 23น' : '6, 12, 18';
                const basalTime = (isFour && bType==='NPH') ? 'sc at 6, 18.00' : 'sc at 23.00';
                
                // Logic from original:
                let basalLineBase, basalLinePlus2, basalLinePlus4, basalLineMinus;
                if (isFour) {
                    basalLineBase = `${bType} ${basal} u ${basalTime}`;
                    basalLinePlus2 = basalLineBase; basalLinePlus4 = basalLineBase; basalLineMinus = basalLineBase;
                } else {
                    basalLineBase = `${bType} ${basal} u ${basalTime}`;
                    basalLinePlus2 = `${bType} ${parseInt(basal)+2} u ${basalTime}`;
                    basalLinePlus4 = `${bType} ${parseInt(basal)+4} u ${basalTime}`;
                    basalLineMinus = `${bType} ${Math.max(0,parseInt(basal)-2)} u ${basalTime}`;
                }

                text = `Continue order\n- DTX ac at ${isFour ? '6, 12, 18, 23น' : '6, 12, 18, and hs'}\n- Off Insulin เดิม\n- ${basalLineBase}\n- ${boType} ${bolus} u sc ac at ${times}\n\n- If dtx >180:\n  - ${basalLinePlus2}\n  - ${boType} ${parseInt(bolus)+2} u sc ac at ${times}\n- If dtx >250:\n  - ${basalLinePlus4}\n  - ${boType} ${parseInt(bolus)+4} u sc ac at ${times}\n- If dtx <140:\n  - ${basalLineMinus}\n  - ${boType} ${Math.max(0,parseInt(bolus)-(isFour?2:4))} u sc ac at ${times}\n\n- If dtx <100, >300, ปรับ feed, NPO pls notify Endocrine`;
            } else {
                const morn = getEl('premixedMorningDose').value;
                const eve = getEl('premixedEveningDose').value;
                const ins = getEl('premixedType').value;
                text = `Continue order\n- Off Insulin เดิม\n- DTX ac bid and hs\n- ${ins} ${morn}-0-${eve} u sc ac\n\n- If DTX < 140:\n  - ${ins} ${Math.max(0,morn-2)}-0-${Math.max(0,eve-2)} u sc ac\n- If DTX > 180:\n  - ${ins} ${parseInt(morn)+2}-0-${parseInt(eve)+2} u sc ac\n- If DTX > 250:\n  - ${ins} ${parseInt(morn)+4}-0-${parseInt(eve)+4} u sc ac\n\n- If dtx <100, >300, ปรับ feed, NPO pls notify Endocrine`;
            }
            
            getEl('orderOutput').textContent = text;
            getEl('copyButton').classList.remove('hidden');
        }

        function copyOrderText() { copyToClipboard(getEl('orderOutput').textContent); }
        function useCalculatedTDD() { if(calculatedTDD) { getEl('tddCorrection').value = calculatedTDD; calculateCorrectionDose(); } }

        function calculateCorrectionDose() {
            const tdd = parseFloat(getEl('tddCorrection').value);
            const current = parseFloat(getEl('current-bg').value);
            const target = parseFloat(getEl('target-bg').value);
            const rule = parseFloat(document.querySelector('input[name="isf-rule"]:checked').value);

            if(tdd && current && target && rule) {
                const isf = rule / tdd;
                const diff = current - target;
                let dose = 0;
                if(diff > 0) dose = diff / isf;
                getEl('results-content-correction').innerHTML = `
                    <div class="p-3 bg-white rounded-md shadow-sm mb-2"><p class="text-sm text-gray-500">1. ISF</p><p class="text-lg font-semibold text-gray-800">${rule} / ${tdd} = <strong>${isf.toFixed(2)}</strong></p></div>
                    <div class="p-3 bg-white rounded-md shadow-sm mb-2"><p class="text-sm text-gray-500">2. Deficit</p><p class="text-lg font-semibold text-gray-800">${current} - ${target} = <strong>${diff}</strong></p></div>
                    <div class="mt-5 p-4 bg-blue-600 text-white rounded-lg text-center shadow-lg"><p class="text-sm uppercase tracking-wider">Recommended Correction Dose</p><p class="text-4xl font-bold">${Math.round(dose)} units</p></div>`;
            }
        }


        // --- NUTRITION LOGIC (SMART PLACEHOLDER) ---
        const nutritionFields = [
            { id: 'ward', default: 'Ward 6ข ขอ consult nutrition ค่า' },
            { id: 'name', default: 'นายกิตติกร เกิดกุล' },
            { id: 'age', default: '55 yr' },
            { id: 'hn', default: '008997-68' },
            { id: 'admit', default: '13/05/68' },
            { id: 'height', default: '165 cm' },
            { id: 'ubw', default: '49 kg (12/67)' },
            { id: 'abw', default: '39 kg (12/05/68)' },
            { id: 'bmi', default: '', readonly: true },
            { id: 'underlying', default: 'not known u/d (last check-up 2566)' },
            { id: 'diagnoses', default: '>> 1st diagnosis : primary CA lung (NSCLC) with Lt main bronchus invade with compress esophagus\n>> obstructive pneumonia at LUL (on tazocin)' },
            { id: 'acp', default: '> คุยล่าสุด (ลูกสาว 13/05/68) full med, full CPR ค่ะ' },
            { id: 'enteral', default: 'มีปัญหา mass compress esophagus (can’t pass NG)' },
            { id: 'npo', default: '- CA lung with compress esophagus (mechanical obstruction) ไม่สามารถ enteral feeding ได้ + can’t pass NG ; NPO ตั้งแต่ 13/05/68-now\n- Consult GI plan set PEG 29/05/68 ***' },
            { id: 'allergies', default: '- ไม่มีค่ะ' },
            { id: 'volume', default: '- hypovolemia' },
            { id: 'io', default: '500/200 (เวรดึกที่ผ่านมา)' },
            { id: 'bun_cr', default: '7/0.58' },
            { id: 'bun_cr_date', default: '13/05/68' },
            { id: 'labs', default: 'lab ล่าสุด elyte phos triglyceride AST ALT และกด compare lab na k phos (ดังรูป)' },
            { id: 'cxr', default: 'CXR ล่าสุด (ดังรูป)' },
            { id: 'naf', default: 'ประเมิน NAF (ดังแนบค่ะ)' }
        ];

        const nutriContainer = getEl('nutrition-form-container');
        const nutriLabels = { ward: 'Ward & Consult Request:', name: 'Patient Name:', age: 'Age (yr):', hn: 'HN:', admit: 'Admit Date:', height: 'Height (cm):', ubw: 'UBW (Usual Body Weight):', abw: 'ABW (Actual Body Weight):', bmi: 'BMI (kg/m²):', underlying: 'Underlying Disease:', diagnoses: 'Diagnoses (Nutrition-related):', acp: 'Advance Care Planning (ACP):', enteral: 'Enteral Feed Contraindications:', npo: 'NPO Details:', allergies: 'Food Allergies/Intolerances/Dislikes:', volume: 'Current Volume Status:', io: 'Latest I/O:', bun_cr: 'BUN/Cr:', bun_cr_date: 'Date:', labs: 'Latest Labs:', cxr: 'Latest CXR:', naf: 'NAF Assessment:' };

        nutritionFields.forEach(f => {
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1";
            div.innerHTML = `<label class="text-xs text-[var(--text-muted)] font-bold">${nutriLabels[f.id] || f.id.toUpperCase()}</label>`;
            
            const input = f.default.includes('\n') ? document.createElement('textarea') : document.createElement('input');
            input.id = 'n_' + f.id;
            input.className = "input-tech text-xs";
            input.value = f.default;
            
            if(f.readonly) {
                input.readOnly = true;
            } else {
                // Store default
                input.dataset.default = f.default;
                input.classList.add('placeholder-active');
                
                // Focus: Clear if default
                input.addEventListener('focus', function() {
                    if (this.value === this.dataset.default) {
                        this.value = '';
                        this.classList.remove('placeholder-active');
                    }
                });
                
                // Blur: Restore if empty
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '') {
                        this.value = this.dataset.default;
                        this.classList.add('placeholder-active');
                    }
                });
            }

            if(input.tagName === 'TEXTAREA') input.rows = f.default.split('\n').length || 2;
            
            div.appendChild(input);
            nutriContainer.appendChild(div);
        });
        
        const updateBMI = () => {
             const hVal = parseFloat(getEl('n_height').value);
             const wVal = parseFloat(getEl('n_abw').value);
             if(hVal && wVal) getEl('n_bmi').value = (wVal/((hVal/100)**2)).toFixed(2) + ' kg/m²';
        };
        getEl('n_height').addEventListener('input', updateBMI);
        getEl('n_abw').addEventListener('input', updateBMI);
        updateBMI(); 

        getEl('nutritionGenerateBtn').addEventListener('click', () => {
            let txt = "";
            // Replicating exact structure from original
            txt += `Ward & Consult Request: ${getEl('n_ward').value}\n\n`;
            txt += `Patient Name: ${getEl('n_name').value}\nAge: ${getEl('n_age').value}\nHN: ${getEl('n_hn').value}\nAdmit Date: ${getEl('n_admit').value}\n\n`;
            txt += `Baseline Patient:\n1. Height: ${getEl('n_height').value}\n2. UBW: ${getEl('n_ubw').value}\n3. ABW: ${getEl('n_abw').value}\nBMI: ${getEl('n_bmi').value}\n\n`;
            txt += `Underlying Disease:\n${getEl('n_underlying').value}\n\n`;
            txt += `Diagnoses (Nutrition-related):\n${getEl('n_diagnoses').value}\n\n`;
            txt += `Advance Care Planning (ACP):\n${getEl('n_acp').value}\n\n`;
            txt += `Enteral Feed Contraindications:\n${getEl('n_enteral').value}\n\n`;
            txt += `NPO Details:\n${getEl('n_npo').value}\n\n`;
            txt += `Food Allergies/Intolerances/Dislikes:\n${getEl('n_allergies').value}\n\n`;
            txt += `Current Volume Status:\n${getEl('n_volume').value}\n\n`;
            txt += `Latest I/O:\n${getEl('n_io').value}\n\n`;
            txt += `BUN/Cr: ${getEl('n_bun_cr').value} (Date: ${getEl('n_bun_cr_date').value})\n\n`;
            txt += `Latest Labs:\n${getEl('n_labs').value}\n\n`;
            txt += `Latest CXR:\n${getEl('n_cxr').value}\n\n`;
            txt += `NAF Assessment:\n${getEl('n_naf').value}`;
            
            getEl('nutritionOutput').value = txt;
        });
        getEl('nutritionCopyBtn').addEventListener('click', () => copyToClipboard(getEl('nutritionOutput').value));
        getEl('nutritionSaveBtn').addEventListener('click', () => {
             const note = getEl('nutritionOutput').value;
             if (!note) return;
             const hn = getEl('n_hn').value.replace(/\//g, '');
             const admit = getEl('n_admit').value.replace(/\//g, '');
             const filename = `consult_note_${hn}_${admit}.txt`;
             const blob = new Blob([note], { type: 'text/plain;charset=utf-8' });
             const link = document.createElement('a');
             link.href = URL.createObjectURL(blob);
             link.download = filename;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        });


        // --- STEROID LOGIC ---
        const steroidEquiv = { hydrocortisone: 20, cortisone: 25, prednisone: 5, prednisolone: 5, methylprednisolone: 4, triamcinolone: 4, dexamethasone: 0.75, betamethasone: 0.6 };
        function calculateSteroidEquivalence() {
            const drug = getEl('steroid_drug').value;
            const dose = parseFloat(getEl('steroid_dose').value);
            const list = getEl('steroidResultsList');
            list.innerHTML = '';
            getEl('steroidResultsSection').classList.remove('hidden');

            if(dose) {
                const base = dose / steroidEquiv[drug];
                for(let k in steroidEquiv) {
                    const equivDose = (base * steroidEquiv[k]).toFixed(2); // Original logic used exact math, rounding handled in display if needed, original displayed 2 decimals
                    // Original formatting:
                    let displayDose = equivDose;
                    if (parseFloat(equivDose) < 1) displayDose = parseFloat(equivDose).toFixed(2);
                    else if (parseFloat(equivDose) < 10) displayDose = parseFloat(equivDose).toFixed(1);
                    else displayDose = parseFloat(equivDose).toFixed(0);

                    const div = document.createElement('div');
                    div.className = "flex justify-between p-2 rounded text-xs " + (k===drug ? "bg-[var(--accent-primary)] text-black font-bold" : "bg-[var(--bg-input)] border border-[var(--border-color)]");
                    div.innerHTML = `<span>${k.charAt(0).toUpperCase() + k.slice(1)}</span><span>${displayDose} mg</span>`;
                    list.appendChild(div);
                }
            }
        }
        
        // --- BETA BLOCKER LOGIC ---
        const bbEquiv = { atenolol: 50, bisoprolol: 5, carvedilol: 25, metoprolol_t: 50, metoprolol_s: 50, nebivolol: 5, propranolol: 40 };
        function calculateBetaBlockerEquivalence() {
             const drug = getEl('bb_drug').value;
             const dose = parseFloat(getEl('bb_dose').value);
             const list = getEl('bbResultsList');
             list.innerHTML = '';
             
             if(dose) {
                 getEl('bbResultsSection').classList.remove('hidden');
                 const base = dose / bbEquiv[drug];
                 for(let k in bbEquiv) {
                     const val = (base * bbEquiv[k]).toFixed(1);
                     const div = document.createElement('div');
                     div.className = "flex justify-between p-2 rounded text-xs " + (k===drug ? "border-l-4 border-[var(--accent-primary)] bg-[var(--bg-input)]" : "border border-[var(--border-color)] opacity-75");
                     div.innerHTML = `<span>${k}</span><span>${val} mg</span>`;
                     list.appendChild(div);
                 }
             }
        }

    </script>
</body>
</html>
